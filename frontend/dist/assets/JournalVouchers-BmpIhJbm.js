import{E as _,r as u,w as v,O as G,c4 as U,o as e,b2 as H,N as S,a3 as B,Q as p}from"./index-jd7Ax_Ed.js";import{A as K}from"./react-select-async.esm-CtFYUcsd.js";import{T as W}from"./trash-2-DCbqoVbR.js";import{P as X}from"./plus-C2o0386P.js";import{S as Y}from"./save-CRYWlTlc.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=_("RefreshCcw",[["path",{d:"M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"14sxne"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16",key:"1hlbsb"}],["path",{d:"M16 16h5v5",key:"ccwih5"}]]),w=()=>new Date().toISOString().split("T")[0],g=()=>({accountId:"",debit:"",credit:"",particulars:""}),ce=()=>{const[y,I]=u.useState({fromDate:w(),toDate:w(),search:""}),[l,d]=u.useState({voucherDate:w(),reference:"",description:"",notes:"",entries:[g(),g()]}),[h,O]=u.useState(new Map),f=u.useCallback(t=>{var s;return((s=t==null?void 0:t.data)==null?void 0:s.accounts)||(t==null?void 0:t.accounts)||(t==null?void 0:t.data)||t||[]},[]),j=u.useCallback(t=>{O(s=>{const a=new Map(s);return t.forEach(r=>{a.set(r._id,r)}),a})},[]),{data:C,isLoading:D,isFetching:F}=useGetAccountsQuery({includePartyAccounts:!0},{onError:t=>{v(t,"Chart of Accounts")}});G.useEffect(()=>{C&&j(f(C))},[C,f,j]);const $=u.useMemo(()=>{const t=Array.from(h.values()).reduce((s,a)=>{let r;if(Array.isArray(a.tags)&&a.tags.includes("customer"))r="Customer Accounts";else if(Array.isArray(a.tags)&&a.tags.includes("supplier"))r="Supplier Accounts";else{const i=a.accountType||"other";r=`${i.charAt(0).toUpperCase()}${i.slice(1)} Accounts`}return s[r]||(s[r]=[]),s[r].push(a),s},{});return Object.entries(t).map(([s,a])=>({label:s,options:a.sort((r,i)=>r.accountCode.localeCompare(i.accountCode)).map(r=>({value:r._id,label:`${r.accountCode} — ${r.accountName}`}))}))},[h]),R=u.useCallback(async t=>{const s=(t==null?void 0:t.trim())||"";try{const a=await U.getAccounts({includePartyAccounts:!0,search:s||void 0}),r=f(a);j(r);const i=r.reduce((o,c)=>{let n;if(Array.isArray(c.tags)&&c.tags.includes("customer"))n="Customer Accounts";else if(Array.isArray(c.tags)&&c.tags.includes("supplier"))n="Supplier Accounts";else{const N=c.accountType||"other";n=`${N.charAt(0).toUpperCase()}${N.slice(1)} Accounts`}return o[n]||(o[n]=[]),o[n].push(c),o},{});return Object.entries(i).map(([o,c])=>({label:o,options:c.sort((n,N)=>n.accountCode.localeCompare(N.accountCode)).map(n=>({value:n._id,label:`${n.accountCode} — ${n.accountName}`}))}))}catch(a){return v(a,"Chart of Accounts"),[]}},[f,j]),{data:x,isLoading:L,isFetching:J}=useGetJournalVouchersQuery({...y,page:1,limit:25},{onError:t=>{v(t,"Journal Vouchers")}}),[V,{isLoading:T}]=useCreateJournalVoucherMutation(),P=async t=>{try{await V(t).unwrap(),p.success("Journal voucher created successfully"),E()}catch(s){v(s,"Create Journal Voucher")}},E=()=>{d({voucherDate:w(),reference:"",description:"",notes:"",entries:[g(),g()]})},m=u.useMemo(()=>{const t=l.entries.reduce((r,i)=>r+(parseFloat(i.debit)||0),0),s=l.entries.reduce((r,i)=>r+(parseFloat(i.credit)||0),0),a=Math.round((t-s)*100)/100;return{debitTotal:Math.round(t*100)/100,creditTotal:Math.round(s*100)/100,difference:a}},[l.entries]),b=(t,s,a)=>{d(r=>{const i=r.entries.map((o,c)=>{if(c!==t)return o;const n={...o,[s]:a};return s==="debit"&&a?n.credit="":s==="credit"&&a&&(n.debit=""),n});return{...r,entries:i}})},q=()=>{d(t=>({...t,entries:[...t.entries,g()]}))},z=t=>{d(s=>s.entries.length<=2?(p.error("At least two entries are required for a journal voucher."),s):{...s,entries:s.entries.filter((a,r)=>r!==t)})},Q=t=>{var r,i,o;if(t.preventDefault(),m.debitTotal<=0){p.error("Total debit must be greater than zero.");return}if(Math.abs(m.difference)>.01){p.error("Total debit and credit must be equal before saving.");return}const s={voucherDate:l.voucherDate,reference:((r=l.reference)==null?void 0:r.trim())||void 0,description:((i=l.description)==null?void 0:i.trim())||void 0,notes:((o=l.notes)==null?void 0:o.trim())||void 0,entries:l.entries.map(c=>{var n;return{accountId:c.accountId,particulars:((n=c.particulars)==null?void 0:n.trim())||"",debit:c.debit?parseFloat(c.debit):0,credit:c.credit?parseFloat(c.credit):0}})};if(s.entries.find(c=>!c.accountId||c.debit<=0&&c.credit<=0)){p.error("Each entry must include an account and either a debit or credit amount.");return}P(s)},A=(t,s)=>{I(a=>({...a,[t]:s}))},k=(x==null?void 0:x.vouchers)||[],M=x==null?void 0:x.pagination;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Journal Vouchers"}),e.jsx("p",{className:"text-gray-600",children:"Record manual ledger adjustments while keeping debits and credits balanced."})]}),e.jsxs("button",{type:"button",onClick:E,className:"btn btn-secondary flex items-center gap-2",children:[e.jsx(Z,{className:"h-4 w-4"}),"Reset Form"]})]}),e.jsx("form",{onSubmit:Q,className:"card",children:e.jsxs("div",{className:"card-content space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Voucher Date"}),e.jsxs("div",{className:"relative",children:[e.jsx(H,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx("input",{type:"date",value:l.voucherDate,onChange:t=>d(s=>({...s,voucherDate:t.target.value})),className:"input pl-10",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference"}),e.jsx("input",{type:"text",value:l.reference,onChange:t=>d(s=>({...s,reference:t.target.value})),className:"input",placeholder:"Optional reference number",maxLength:100})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("input",{type:"text",value:l.description,onChange:t=>d(s=>({...s,description:t.target.value})),className:"input",placeholder:"Purpose of this journal voucher",maxLength:1e3})]})]}),F&&e.jsxs("div",{className:"text-sm text-gray-500 flex items-center gap-2",children:[e.jsx(S,{size:"sm",inline:!0}),"Fetching accounts..."]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Account"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Particulars"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Debit"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Credit"}),e.jsx("th",{className:"px-4 py-3"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:l.entries.map((t,s)=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"space-y-2",children:e.jsx(K,{cacheOptions:!0,defaultOptions:$,loadOptions:R,value:t.accountId&&h.has(t.accountId)?{value:t.accountId,label:`${h.get(t.accountId).accountCode} — ${h.get(t.accountId).accountName}`}:null,onChange:a=>b(s,"accountId",a?a.value:""),isLoading:D||F,placeholder:"Select account",styles:{control:a=>({...a,minHeight:"2.5rem"}),menu:a=>({...a,zIndex:20})},isClearable:!0})})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("input",{type:"text",value:t.particulars,onChange:a=>b(s,"particulars",a.target.value),className:"input w-full min-w-[220px]",placeholder:"Narration / memo",maxLength:500})}),e.jsx("td",{className:"px-4 py-3 w-28",children:e.jsx("input",{type:"number",min:"0",step:"0.01",value:t.debit,onChange:a=>b(s,"debit",a.target.value),className:"input text-right w-full min-w-[90px]",placeholder:"0.00"})}),e.jsx("td",{className:"px-4 py-3 w-28",children:e.jsx("input",{type:"number",min:"0",step:"0.01",value:t.credit,onChange:a=>b(s,"credit",a.target.value),className:"input text-right w-full min-w-[90px]",placeholder:"0.00"})}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsx("button",{type:"button",onClick:()=>z(s),className:"text-red-500 hover:text-red-700","aria-label":"Remove line",children:e.jsx(W,{className:"h-4 w-4"})})})]},s))}),e.jsxs("tfoot",{className:"bg-gray-50",children:[e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3",children:e.jsxs("button",{type:"button",onClick:q,className:"btn btn-secondary btn-sm flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4"}),"Add Line"]})}),e.jsx("td",{className:"px-4 py-3 text-right font-medium text-gray-700",children:"Totals"}),e.jsx("td",{className:"px-4 py-3 text-right font-semibold text-gray-900",children:m.debitTotal.toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-right font-semibold text-gray-900",children:m.creditTotal.toFixed(2)}),e.jsx("td",{className:"px-4 py-3"})]}),e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"px-4 pb-3 text-right",children:e.jsxs("span",{className:`text-sm font-medium ${Math.abs(m.difference)<.01?"text-green-600":"text-red-600"}`,children:["Difference: ",m.difference.toFixed(2)]})})})]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("textarea",{value:l.notes,onChange:t=>d(s=>({...s,notes:t.target.value})),className:"input",rows:3,placeholder:"Optional notes or supporting details"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"submit",className:"btn btn-primary flex items-center gap-2",disabled:T||D,children:T?e.jsxs(e.Fragment,{children:[e.jsx(S,{size:"sm",inline:!0,className:"mr-2"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"h-4 w-4"}),"Save Voucher"]})})})]})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"card-content",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 w-full",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"From Date"}),e.jsx("input",{type:"date",value:y.fromDate,onChange:t=>A("fromDate",t.target.value),className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"To Date"}),e.jsx("input",{type:"date",value:y.toDate,onChange:t=>A("toDate",t.target.value),className:"input"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Search"}),e.jsx("input",{type:"text",value:y.search,onChange:t=>A("search",t.target.value),className:"input",placeholder:"Voucher no, account, description..."})]})]}),e.jsxs("button",{type:"button",onClick:()=>queryClient.invalidateQueries("journalVouchers"),className:"btn btn-secondary flex items-center gap-2 self-start md:self-auto",children:[e.jsx(B,{className:"h-4 w-4"}),"Refresh List"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Voucher #"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Description"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Total Debit"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Total Credit"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Lines"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[(L||J)&&e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"px-4 py-6 text-center",children:e.jsx(S,{})})}),!L&&k.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"px-4 py-6 text-center text-gray-500",children:"No journal vouchers found for the selected filters."})}),k.map(t=>{var s,a,r;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:t.voucherNumber}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:new Date(t.voucherDate).toLocaleDateString()}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:t.description||t.reference||"—"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:(s=t.totalDebit)==null?void 0:s.toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:(a=t.totalCredit)==null?void 0:a.toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:((r=t.entries)==null?void 0:r.length)||0})]},t._id)})]})]})}),M&&e.jsxs("div",{className:"mt-4 text-sm text-gray-600",children:["Showing ",k.length," of ",M.totalItems," voucher(s)"]})]})})]})};export{ce as JournalVouchers,ce as default};
