import{D as bt,r as n,p as e,X as es,E as ts,F as Je,L as xe,B as te,y as re,G as ss,H as Ze,P as Ne,I as mt,t as et,T as Xe,x as Ke,J as rs,K as as,u as ns,a as cs,d as os,M as is,N as ls,U as ds,s as us,A as ms,v as xs,O as ps,z as L,R as hs,Q as se}from"./index-Cw3xRKpc.js";import{u as yt,b as jt,a as fs}from"./productsApi-DhOlFJ93.js";import{u as gs}from"./banksApi-DWzaClHP.js";import{u as bs}from"./useFuzzySearch-ZiMs9RBo.js";import{S as vt}from"./SearchableDropdown-CdqaVq-Q.js";import{A as ys}from"./AsyncErrorBoundary-O-YjuvhS.js";import{C as js}from"./ConfirmationDialog-CxU4qXW2.js";import{u as vs}from"./useConfirmation-BJ-PhpCl.js";import{C as Ns}from"./check-DKrAXHMA.js";import{A as me}from"./alert-circle-HQsWpy-L.js";import{P as ws}from"./PrintModal-DmgjaKQ0.js";import{E as tt}from"./eye-DISpb38e.js";import{H as Ps,S as Ge}from"./sparkles-FkDu0AJg.js";import{S as Ss}from"./star-DfLDu3VG.js";import{g as Cs}from"./ComponentRegistry-Bivjkut0.js";import{C as ks,B as _s}from"./BarcodeScanner-BrX89TyU.js";import{D as xt}from"./download-B8XL5QGf.js";import{P as Nt}from"./plus-DxsvPhf3.js";import{E as $s}from"./eye-off-DT0V_He4.js";import{C as As}from"./calculator-9IOFXN46.js";import{H as Ms}from"./history-B8jJndAB.js";import{C as pt}from"./check-circle-C7396OEq.js";import{I as ht}from"./info-9RksQo07.js";import{T as ft}from"./trash-2-D2rrIU_x.js";import{P as Rs}from"./printer-Bdyt47kH.js";import{X as Es}from"./x-circle-MQqDWFsw.js";import"./chevron-down-BKU-tyXN.js";import"./shield-Bzu0Nlf_.js";import"./useCompanyInfo-B4fVT8rp.js";import"./settingsApi-ygxRjDN0.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ls=bt("Gift",[["rect",{x:"3",y:"8",width:"18",height:"4",rx:"1",key:"bkv52"}],["path",{d:"M12 8v13",key:"1c76mn"}],["path",{d:"M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7",key:"6wjy6b"}],["path",{d:"M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5",key:"1ihvrl"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gt=bt("Smartphone",[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]]),Ts=({isOpen:k,onClose:o,orderData:g,onPaymentSuccess:E,onPaymentError:x})=>{var F;const[j,r]=n.useState(""),[T,H]=n.useState(""),[p,P]=n.useState({number:"",expiryMonth:"",expiryYear:"",cvc:"",holderName:""}),[q,D]=n.useState(!1),[d,y]=n.useState({}),B=[{id:"cash",name:"Cash",icon:ts,description:"Cash payment",color:"text-green-600",bgColor:"bg-green-50",borderColor:"border-green-200"},{id:"credit_card",name:"Credit Card",icon:Je,description:"Visa, Mastercard, Amex",color:"text-blue-600",bgColor:"bg-blue-50",borderColor:"border-blue-200"},{id:"debit_card",name:"Debit Card",icon:Je,description:"Visa, Mastercard debit",color:"text-purple-600",bgColor:"bg-purple-50",borderColor:"border-purple-200"},{id:"digital_wallet",name:"Digital Wallet",icon:gt,description:"Apple Pay, Google Pay",color:"text-orange-600",bgColor:"bg-orange-50",borderColor:"border-orange-200"},{id:"check",name:"Check",icon:Ns,description:"Check payment",color:"text-gray-600",bgColor:"bg-gray-50",borderColor:"border-gray-200"},{id:"gift_card",name:"Gift Card",icon:Ls,description:"Store gift card",color:"text-pink-600",bgColor:"bg-pink-50",borderColor:"border-pink-200"},{id:"store_credit",name:"Store Credit",icon:Je,description:"Store credit account",color:"text-indigo-600",bgColor:"bg-indigo-50",borderColor:"border-indigo-200"}];n.useEffect(()=>{g&&g.total&&H(g.total.toString())},[g]),n.useEffect(()=>{k||(r(""),H(""),P({number:"",expiryMonth:"",expiryYear:"",cvc:"",holderName:""}),y({}))},[k]);const u=()=>{const l={};return j||(l.method="Please select a payment method"),(!T||parseFloat(T)<=0)&&(l.amount="Please enter a valid amount"),g&&parseFloat(T)>g.total&&(l.amount="Amount cannot exceed order total"),["credit_card","debit_card"].includes(j)&&((!p.number||p.number.length<13)&&(l.cardNumber="Please enter a valid card number"),(!p.expiryMonth||!p.expiryYear)&&(l.cardExpiry="Please enter card expiry date"),(!p.cvc||p.cvc.length<3)&&(l.cardCvc="Please enter a valid CVC"),p.holderName||(l.cardHolder="Please enter cardholder name")),y(l),Object.keys(l).length===0},b=async()=>{if(u()){D(!0),y({});try{const l={orderId:g._id,paymentMethod:j,amount:parseFloat(T),currency:"USD",gateway:["credit_card","debit_card","digital_wallet"].includes(j)?"stripe":"manual",cardDetails:["credit_card","debit_card"].includes(j)?p:void 0,metadata:{terminalId:"POS_001",location:"Main Store",ipAddress:"127.0.0.1",userAgent:navigator.userAgent}},w=await(await fetch("/api/payments/process",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(l)})).json();if(w.success)te("Payment processed successfully!"),E&&E(w.data),o();else throw new Error(w.message||"Payment processing failed")}catch(l){console.error("Payment error:",l),re(l,"Payment Processing"),x&&x(l)}finally{D(!1)}}},_=l=>{const v=l.replace(/\s+/g,"").replace(/[^0-9]/gi,""),w=v.match(/\d{4,16}/g),O=w&&w[0]||"",W=[];for(let M=0,z=O.length;M<z;M+=4)W.push(O.substring(M,M+4));return W.length?W.join(" "):v},$=l=>{const v=_(l.target.value);P(w=>({...w,number:v}))};return k?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Process Payment"}),e.jsx("button",{onClick:o,className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(es,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[g&&e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h3",{className:"font-medium text-gray-900 mb-2",children:"Order Summary"}),e.jsxs("div",{className:"text-sm text-gray-600 space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Order #:"}),e.jsx("span",{children:g.orderNumber||g._id})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total Amount:"}),e.jsxs("span",{className:"font-medium",children:["$",(F=g.total)==null?void 0:F.toFixed(2)]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Select Payment Method"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:B.map(l=>{const v=l.icon;return e.jsx("button",{onClick:()=>r(l.id),className:`p-4 rounded-lg border-2 transition-all ${j===l.id?`${l.borderColor} ${l.bgColor} ring-2 ring-offset-2 ring-current`:"border-gray-200 hover:border-gray-300"}`,children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(v,{className:`h-6 w-6 ${l.color}`}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:`font-medium ${l.color}`,children:l.name}),e.jsx("div",{className:"text-xs text-gray-500",children:l.description})]})]})},l.id)})}),d.method&&e.jsxs("p",{className:"mt-1 text-sm text-red-600 flex items-center",children:[e.jsx(me,{className:"h-4 w-4 mr-1"}),d.method]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Payment Amount"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:(g==null?void 0:g.total)||999999,value:T,onChange:l=>H(l.target.value),className:"block w-full pl-7 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"0.00"})]}),d.amount&&e.jsxs("p",{className:"mt-1 text-sm text-red-600 flex items-center",children:[e.jsx(me,{className:"h-4 w-4 mr-1"}),d.amount]})]}),["credit_card","debit_card"].includes(j)&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Card Details"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Card Number"}),e.jsx("input",{type:"text",value:p.number,onChange:$,className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"1234 5678 9012 3456",maxLength:"19"}),d.cardNumber&&e.jsxs("p",{className:"mt-1 text-sm text-red-600 flex items-center",children:[e.jsx(me,{className:"h-4 w-4 mr-1"}),d.cardNumber]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Expiry Date"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{type:"number",value:p.expiryMonth,onChange:l=>P(v=>({...v,expiryMonth:l.target.value})),className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"MM",min:"1",max:"12"}),e.jsx("input",{type:"number",value:p.expiryYear,onChange:l=>P(v=>({...v,expiryYear:l.target.value})),className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"YYYY",min:"2024"})]}),d.cardExpiry&&e.jsxs("p",{className:"mt-1 text-sm text-red-600 flex items-center",children:[e.jsx(me,{className:"h-4 w-4 mr-1"}),d.cardExpiry]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"CVC"}),e.jsx("input",{type:"text",value:p.cvc,onChange:l=>P(v=>({...v,cvc:l.target.value.replace(/\D/g,"")})),className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"123",maxLength:"4"}),d.cardCvc&&e.jsxs("p",{className:"mt-1 text-sm text-red-600 flex items-center",children:[e.jsx(me,{className:"h-4 w-4 mr-1"}),d.cardCvc]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cardholder Name"}),e.jsx("input",{type:"text",value:p.holderName,onChange:l=>P(v=>({...v,holderName:l.target.value})),className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"John Doe"}),d.cardHolder&&e.jsxs("p",{className:"mt-1 text-sm text-red-600 flex items-center",children:[e.jsx(me,{className:"h-4 w-4 mr-1"}),d.cardHolder]})]})]}),j==="digital_wallet"&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(gt,{className:"h-5 w-5 text-blue-600 mr-2"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium",children:"Digital Wallet Payment"}),e.jsx("p",{children:"This will open your digital wallet for payment processing."})]})]})})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-3 p-6 border-t bg-gray-50",children:[e.jsx("button",{onClick:o,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",disabled:q,children:"Cancel"}),e.jsx(xe,{onClick:b,loading:q,className:"px-4 py-2 text-sm font-medium text-white bg-primary-600 border border-transparent rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:q?"Processing...":"Process Payment"})]})]})}):null},Is=ss.injectEndpoints({endpoints:k=>({generateRecommendations:k.mutation({query:o=>({url:"recommendations/generate",method:"post",data:o})}),getRecommendation:k.query({query:o=>({url:`recommendations/${o}`,method:"get"}),providesTags:(o,g,E)=>[{type:"Settings",id:`RECOMMENDATION_${E}`}]}),trackInteraction:k.mutation({query:({recommendationId:o,...g})=>({url:`recommendations/${o}/interactions`,method:"post",data:g})}),trackBehavior:k.mutation({query:o=>({url:"recommendations/behavior",method:"post",data:o})}),getPerformance:k.query({query:o=>({url:"recommendations/performance",method:"get",params:o}),providesTags:[{type:"Reports",id:"RECOMMENDATIONS_PERFORMANCE"}]}),getUserRecommendations:k.query({query:({userId:o,...g})=>({url:`recommendations/user/${o}`,method:"get",params:g}),providesTags:(o,g,{userId:E})=>[{type:"Settings",id:`USER_RECOMMENDATIONS_${E}`}]})}),overrideExisting:!1}),{useGenerateRecommendationsMutation:Bs,useTrackInteractionMutation:Fs,useTrackBehaviorMutation:Os}=Is,qs=({src:k,webpSrc:o,alt:g="",className:E="",sizes:x=null,lazy:j=!0,fallback:r=null,style:T={},...H})=>{const[p,P]=n.useState(!1),[q,D]=n.useState(!1),[d,y]=n.useState(!j),B=n.useRef(null);n.useEffect(()=>{if(!j||d)return;const v=new IntersectionObserver(w=>{w.forEach(O=>{O.isIntersecting&&(y(!0),v.disconnect())})},{rootMargin:"50px"});return B.current&&v.observe(B.current),()=>{B.current&&v.unobserve(B.current),v.disconnect()}},[j,d]);const u=()=>{if(!x||!o)return null;const v=[],w=o.replace(/\.webp$/,"");return x.thumbnail&&v.push(`${w}_thumbnail.webp 150w`),x.small&&v.push(`${w}_small.webp 300w`),x.medium&&v.push(`${w}_medium.webp 600w`),x.large&&v.push(`${w}_large.webp 1200w`),v.length>0?v.join(", "):null},b=()=>"(max-width: 640px) 300px, (max-width: 1024px) 600px, 1200px",_=()=>{P(!0)},$=()=>{D(!0)};if(j&&!d)return e.jsx("div",{ref:B,className:`bg-gray-200 animate-pulse ${E}`,style:{minHeight:"200px",...T},...H});if(q)return r?e.jsx("img",{src:r,alt:g,className:E,style:T,...H}):e.jsx("div",{className:`bg-gray-200 flex items-center justify-center ${E}`,style:{minHeight:"200px",...T},...H,children:e.jsx("span",{className:"text-gray-400 text-sm",children:"Image not available"})});const F=u(),l=F?b():void 0;return e.jsxs("picture",{ref:B,className:E,style:T,children:[o&&F&&e.jsx("source",{srcSet:F,sizes:l,type:"image/webp"}),o&&!F&&e.jsx("source",{srcSet:o,type:"image/webp"}),e.jsx("img",{src:k,alt:g,className:`${E} ${p?"opacity-100 transition-opacity duration-300":"opacity-0"}`,onLoad:_,onError:$,loading:j?"lazy":"eager",decoding:"async",...H})]})},Ds=({recommendation:k,position:o,onAddToCart:g,onViewProduct:E,showReason:x=!0,showScore:j=!1,className:r=""})=>{var v,w,O,W,M,z,S,Q;const[T,H]=n.useState(!1),[p,P]=n.useState(!1),{isMobile:q}=Ze(),[D]=Fs(),{product:d,score:y,reason:B}=k,u=async()=>{if(!p){P(!0);try{k._id&&await D({recommendationId:k._id,productId:d._id,action:"add_to_cart",position:o}).unwrap(),g&&await g(d)}catch(I){re(I,"Add to Cart")}finally{P(!1)}}},b=async()=>{try{k._id&&await D({recommendationId:k._id,productId:d._id,action:"click",position:o}).unwrap(),E&&E(d)}catch(I){re(I,"View Product")}},_=()=>{switch(B){case"trending":return e.jsx(Xe,{className:"h-4 w-4 text-orange-500"});case"frequently_bought_together":return e.jsx(Ne,{className:"h-4 w-4 text-blue-500"});case"similar_products":return e.jsx(Ne,{className:"h-4 w-4 text-purple-500"});case"seasonal":return e.jsx(Ss,{className:"h-4 w-4 text-yellow-500"});case"collaborative_filtering":return e.jsx(Ps,{className:"h-4 w-4 text-red-500"});case"content_similarity":return e.jsx(Ne,{className:"h-4 w-4 text-green-500"});case"price_range":return e.jsx(Ne,{className:"h-4 w-4 text-indigo-500"});default:return e.jsx(Ne,{className:"h-4 w-4 text-gray-500"})}},$=()=>{switch(B){case"trending":return"Trending Now";case"frequently_bought_together":return"Frequently Bought Together";case"similar_products":return"Similar Products";case"seasonal":return"Seasonal Pick";case"collaborative_filtering":return"Customers Also Bought";case"content_similarity":return"You Might Like";case"price_range":return"In Your Price Range";default:return"Recommended"}},F=((v=d.inventory)==null?void 0:v.currentStock)<=((w=d.inventory)==null?void 0:w.reorderPoint),l=((O=d.inventory)==null?void 0:O.currentStock)===0;return e.jsxs("div",{className:`bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 ${r}`,onMouseEnter:()=>H(!0),onMouseLeave:()=>H(!1),children:[e.jsxs("div",{className:"relative aspect-square bg-gray-100 rounded-t-lg overflow-hidden",children:[d.image?e.jsx(qs,{src:d.image,webpSrc:d.imageWebp||((W=d.image)==null?void 0:W.replace(/\.(jpg|jpeg|png)$/i,".webp")),alt:d.name,className:"w-full h-full object-cover",sizes:{thumbnail:!0,small:!0,medium:!0,large:!0},lazy:!0}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx(Ne,{className:"h-12 w-12 text-gray-400"})}),(F||l)&&e.jsx("div",{className:"absolute top-2 right-2",children:l?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800",children:[e.jsx(mt,{className:"h-3 w-3 mr-1"}),"Out of Stock"]}):e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800",children:[e.jsx(mt,{className:"h-3 w-3 mr-1"}),"Low Stock"]})}),x&&e.jsx("div",{className:"absolute top-2 left-2",children:e.jsxs("div",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-white bg-opacity-90 text-gray-700",children:[_(),e.jsx("span",{className:"ml-1 hidden sm:inline",children:$()})]})}),j&&e.jsx("div",{className:"absolute bottom-2 right-2",children:e.jsxs("div",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:[Math.round(y*100),"%"]})})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900 text-sm line-clamp-2 mb-1",children:d.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Category: ",d.category||"N/A"]})]}),e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:"text-lg font-bold text-gray-900",children:["$",((z=(M=d.pricing)==null?void 0:M.retail)==null?void 0:z.toFixed(2))||"0.00"]}),((S=d.pricing)==null?void 0:S.wholesale)&&d.pricing.wholesale!==d.pricing.retail&&e.jsxs("span",{className:"text-sm text-gray-500 line-through",children:["$",d.pricing.wholesale.toFixed(2)]})]})}),e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-500",children:"Stock:"}),e.jsx("span",{className:`font-medium ${l?"text-red-600":F?"text-yellow-600":"text-green-600"}`,children:((Q=d.inventory)==null?void 0:Q.currentStock)||0})]})}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{onClick:b,className:"flex-1 btn btn-secondary btn-sm flex items-center justify-center",children:[e.jsx(tt,{className:"h-4 w-4 mr-1"}),q?"View":"View Details"]}),e.jsx("button",{onClick:u,disabled:l||p,className:"flex-1 btn btn-primary btn-sm flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed",children:p?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsxs(e.Fragment,{children:[e.jsx(et,{className:"h-4 w-4 mr-1"}),q?"Add":"Add to Cart"]})})]}),e.jsx("div",{className:"mt-2 flex justify-center",children:e.jsx("button",{onClick:async()=>{try{k._id&&await D({recommendationId:k._id,productId:d._id,action:"dismiss",position:o}).unwrap()}catch(I){re(I,"Dismiss Recommendation")}},className:"text-xs text-gray-400 hover:text-gray-600 transition-colors",children:"Not interested"})})]})]})},Us=({title:k="Recommended for You",algorithm:o="hybrid",context:g={},limit:E=8,showTitle:x=!0,showControls:j=!0,onAddToCart:r,onViewProduct:T,className:H=""})=>{var W,M,z;const[p]=n.useState(()=>`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),[P,q]=n.useState(o),[D,d]=n.useState(!1),[y,B]=n.useState(null),[u,b]=n.useState(null);Ze();const[_,{isLoading:$}]=Bs();n.useEffect(()=>{(async()=>{try{b(null);const Q=await _({sessionId:p,algorithm:P,context:g,limit:E}).unwrap();B(Q)}catch(Q){b(Q),re(Q,"Recommendations")}})()},[P,p,E]);const F=async()=>{d(!0);try{b(null);const S=await _({sessionId:p,algorithm:P,context:g,limit:E}).unwrap();B(S),te("Recommendations updated")}catch(S){b(S),re(S,"Refresh Recommendations")}finally{d(!1)}},l=S=>{q(S)},v=async S=>{try{r&&await r(S),te(`${S.name} added to cart`)}catch(Q){re(Q,"Add to Cart")}},w=S=>{T&&T(S)},O=[{value:"hybrid",label:"Smart Recommendations",icon:Ge},{value:"trending",label:"Trending Now",icon:Xe},{value:"frequently_bought",label:"Frequently Bought",icon:et},{value:"similar_products",label:"Similar Products",icon:tt},{value:"collaborative",label:"Others Also Bought",icon:Xe},{value:"seasonal",label:"Seasonal Picks",icon:Ge}];return u?e.jsxs("div",{className:`text-center py-8 ${H}`,children:[e.jsx("div",{className:"text-red-500 mb-4",children:e.jsx(Ke,{className:"h-8 w-8 mx-auto"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Unable to load recommendations"}),e.jsx("p",{className:"text-gray-500 mb-4",children:u.message}),e.jsx("button",{onClick:F,className:"btn btn-primary",children:"Try Again"})]}):e.jsxs(rs,{className:H,children:[x&&e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-primary-100 rounded-lg",children:e.jsx(Ge,{className:"h-6 w-6 text-primary-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:k}),e.jsx("p",{className:"text-sm text-gray-500",children:(W=O.find(S=>S.value===P))==null?void 0:W.label})]})]}),j&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("select",{value:P,onChange:S=>l(S.target.value),className:"select select-sm",children:O.map(S=>e.jsx("option",{value:S.value,children:S.label},S.value))}),e.jsx(xe,{onClick:F,isLoading:D,className:"btn btn-secondary btn-sm",children:e.jsx(Ke,{className:"h-4 w-4"})})]})]}),$&&e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:Array.from({length:E}).map((S,Q)=>e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"aspect-square bg-gray-200 rounded-lg mb-4"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-2/3 mb-2"}),e.jsx("div",{className:"h-6 bg-gray-200 rounded w-1/2 mb-4"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded flex-1"}),e.jsx("div",{className:"h-8 bg-gray-200 rounded flex-1"})]})]})},Q))}),(y==null?void 0:y.recommendations)&&e.jsx(as,{cols:{default:2,md:3,lg:4},gap:4,className:"mb-6",children:y.recommendations.map((S,Q)=>e.jsx(Ds,{recommendation:{...S,_id:y.recommendationId},position:Q+1,onAddToCart:v,onViewProduct:w,showReason:!0,showScore:!1},`${S.product._id}-${Q}`))}),((M=y==null?void 0:y.recommendations)==null?void 0:M.length)===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-gray-400 mb-4",children:e.jsx(Ge,{className:"h-12 w-12 mx-auto"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No recommendations available"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"We need more data to provide personalized recommendations."}),e.jsxs("button",{onClick:F,className:"btn btn-primary",children:[e.jsx(Ke,{className:"h-4 w-4 mr-2"}),"Refresh"]})]}),(y==null?void 0:y.metadata)&&e.jsx("div",{className:"mt-4 p-3 bg-gray-50 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[e.jsxs("span",{children:["Generated in ",y.metadata.processingTime,"ms"]}),e.jsxs("span",{children:[((z=y.recommendations)==null?void 0:z.length)||0," recommendations"]})]})})]})},Gs=()=>`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,Hs=()=>{let k=sessionStorage.getItem("recommendation_session_id");return k||(k=Gs(),sessionStorage.setItem("recommendation_session_id",k)),k},Vs=()=>{const k=n.useRef(Hs()),o=n.useRef([]),g=n.useRef(!1),[E]=Os(),x=async u=>{const b={sessionId:k.current,...u,timestamp:new Date().toISOString()};o.current.push(b),g.current||j()},j=async()=>{if(!(g.current||o.current.length===0)){for(g.current=!0;o.current.length>0;){const u=o.current.shift();try{await E(u).unwrap()}catch(b){console.error("Error tracking behavior:",b),(u.action==="purchase"||u.action==="add_to_cart")&&o.current.unshift(u)}}g.current=!1}},r=(u,b=null)=>{x({action:"page_view",entity:{type:"page",name:u},context:{page:u,referrer:b,userAgent:navigator.userAgent,timestamp:Date.now()}})},T=(u,b=null)=>{var _;x({action:"product_view",entity:{type:"product",id:u._id,ref:"Product",name:u.name,category:u.category},metadata:{productPrice:(_=u.pricing)==null?void 0:_.retail,position:b}})},H=(u,b=null)=>{var _;x({action:"product_click",entity:{type:"product",id:u._id,ref:"Product",name:u.name,category:u.category},metadata:{productPrice:(_=u.pricing)==null?void 0:_.retail,position:b}})},p=(u,b=1,_=null)=>{var $,F;x({action:"add_to_cart",entity:{type:"product",id:u._id,ref:"Product",name:u.name,category:u.category},metadata:{productPrice:($=u.pricing)==null?void 0:$.retail,quantity:b,position:_,cartValue:((F=u.pricing)==null?void 0:F.retail)*b}})},P=(u,b=1,_=null)=>{var $;x({action:"remove_from_cart",entity:{type:"product",id:u._id,ref:"Product",name:u.name,category:u.category},metadata:{productPrice:($=u.pricing)==null?void 0:$.retail,quantity:b,position:_}})},q=(u,b,_=null)=>{u.forEach(($,F)=>{var l,v,w,O,W;x({action:"purchase",entity:{type:"product",id:$._id||((l=$.product)==null?void 0:l._id),ref:"Product",name:$.name||((v=$.product)==null?void 0:v.name),category:$.category||((w=$.product)==null?void 0:w.category)},metadata:{productPrice:$.price||((W=(O=$.product)==null?void 0:O.pricing)==null?void 0:W.retail),quantity:$.quantity,position:F+1,totalAmount:b,orderId:_}})})},D=(u,b=0,_={})=>{x({action:"search",entity:{type:"search",name:u},metadata:{searchQuery:u,resultsCount:b,filterCriteria:_}})},d=(u,b=null)=>{x({action:"category_view",entity:{type:"category",id:u._id,ref:"Category",name:u.name},metadata:{position:b}})},y=(u,b,_=0)=>{x({action:"filter",entity:{type:"filter",name:u},metadata:{filterType:u,filterValue:b,resultsCount:_}})},B=(u,b,_,$=null)=>{x({action:`recommendation_${_}`,entity:{type:"product",id:b,ref:"Product"},metadata:{recommendationId:u,position:$,interactionType:_}})};return n.useEffect(()=>()=>{o.current.length>0&&j()},[]),{sessionId:k.current,trackBehavior:x,trackPageView:r,trackProductView:T,trackProductClick:H,trackAddToCart:p,trackRemoveFromCart:P,trackPurchase:q,trackSearch:D,trackCategoryView:d,trackFilter:y,trackRecommendationInteraction:B}},Ys=({onAddProduct:k,selectedCustomer:o,showCostPrice:g,onLastPurchasePriceFetched:E,hasCostPricePermission:x,priceType:j,onRefetchReady:r})=>{const[T,H]=n.useState(""),[p,P]=n.useState(null),[q,D]=n.useState(1),[d,y]=n.useState(""),[B,u]=n.useState(0),[b,_]=n.useState(!1),[$,F]=n.useState(!1),[l,v]=n.useState(0),[w,O]=n.useState(null),[W,M]=n.useState(!1),z=n.useRef(null),[S]=yt(),[Q]=jt(),{data:I,isLoading:ce,error:ge,refetch:pe}=fs({limit:100,status:"active"},{keepPreviousData:!0,staleTime:0,refetchOnMountOrArgChange:!0});n.useEffect(()=>{r&&pe&&typeof pe=="function"&&r(pe)},[r,pe]);const ie=hs.useMemo(()=>{var m,V,U;return I?Array.isArray(I)?I:(m=I==null?void 0:I.data)!=null&&m.products?I.data.products:I!=null&&I.products?I.products:(U=(V=I==null?void 0:I.data)==null?void 0:V.data)!=null&&U.products?I.data.data.products:[]:[]},[I]),be=bs(ie,T,["name","description","brand"],{threshold:.4,minScore:.3,limit:10}),we=(m,V)=>m?V==="wholesale"?m.pricing.wholesale||m.pricing.retail:V==="retail"?m.pricing.retail:m.pricing.wholesale||m.pricing.retail:0,ye=async m=>{if(P(m),D(1),_(!0),H(m.name),m._id)try{const U=await S(m._id).unwrap();U&&U.lastPurchasePrice!==null?(O(U.lastPurchasePrice),E&&E(m._id,U.lastPurchasePrice)):O(null)}catch{O(null)}else O(null);const V=we(m,j);u(V),y(V.toString())};n.useEffect(()=>{if(p){const m=we(p,j);u(m);const V=we(p,j==="wholesale"?"retail":"wholesale");(!d||d===V.toString()||d===B.toString())&&y(m.toString())}},[j,p]);const Le=async()=>{if(p){if(!d||parseInt(d)<=0){se.error("Please enter a valid rate");return}if(p.inventory.currentStock===0){se.error(`${p.name} is out of stock and cannot be added to the invoice.`);return}if(q>p.inventory.currentStock){se.error(`Cannot add ${q} units. Only ${p.inventory.currentStock} units available in stock.`);return}F(!0);try{const m=parseInt(d)||Math.round(B);if(w!==null&&m<w){const U=w-m,X=(U/w*100).toFixed(1);if(!window.confirm(`⚠️ WARNING: Sale price ($${m}) is below cost price ($${Math.round(w)}).

Loss per unit: $${Math.round(U)} (${X}%)
Total loss for ${q} unit(s): $${Math.round(U*q)}

Do you want to proceed?`))return;se.warning(`Product added with loss: $${Math.round(U)} per unit (${X}%)`,{duration:6e3})}k({product:p,quantity:q,unitPrice:m}),P(null),D(1),y(""),u(0),_(!1),H(""),v(U=>U+1),setTimeout(()=>{z.current&&z.current.focus()},100);const V=(o==null?void 0:o.businessType)==="wholesale"?"wholesale":(o==null?void 0:o.businessType)==="distributor"?"distributor":"retail";se.success(`${p.name} added to cart at ${V} price: ${Math.round(m)}`)}catch(m){re(m,"Product Price Check")}finally{F(!1)}}},Pe=m=>{m.key==="Enter"&&b?(m.preventDefault(),Le()):m.key==="Escape"&&b&&(m.preventDefault(),P(null),D(1),y(""),u(0),_(!1))},He=m=>{var X;m.inventory.currentStock<=m.inventory.reorderPoint,m.inventory.currentStock;let V=m.pricing.wholesale||m.pricing.retail;j==="wholesale"?V=m.pricing.wholesale||m.pricing.retail:j==="retail"&&(V=m.pricing.retail);const U=((X=m.pricing)==null?void 0:X.cost)||0;return e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("div",{className:"font-medium",children:m.name}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Stock: ",m.inventory.currentStock]}),g&&x&&e.jsxs("div",{className:"text-sm text-red-600 font-medium",children:["Cost: $",Math.round(U)]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Price: $",Math.round(V)]})]})]})},Te=g&&x?"col-span-6":"col-span-7";return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-12 gap-4 items-end",children:[e.jsxs("div",{className:Te,children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Product Search"}),e.jsxs("div",{className:"relative flex space-x-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx(vt,{ref:z,placeholder:"Search or select product...",items:be||[],onSelect:ye,onSearch:H,displayKey:He,selectedItem:p,loading:ce,emptyMessage:T.length>0?"No products found":"Start typing to search products...",value:T},l)}),e.jsx("button",{type:"button",onClick:()=>M(!0),className:"px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors flex items-center justify-center",title:"Scan barcode to search product",children:e.jsx(ks,{className:"h-5 w-5 text-gray-600"})})]})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock"}),e.jsx("span",{className:"text-sm font-semibold text-gray-700 bg-gray-100 px-2 py-1 rounded border border-gray-200 block text-center h-10 flex items-center justify-center",children:p?p.inventory.currentStock:"0"})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Quantity"}),e.jsx("input",{type:"number",min:"1",max:p==null?void 0:p.inventory.currentStock,value:q,onChange:m=>D(parseInt(m.target.value)||1),onKeyDown:Pe,onFocus:m=>m.target.select(),className:"input text-center",placeholder:"1 (Enter to add & focus search)",autoFocus:b})]}),g&&x&&e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Cost"}),e.jsx("span",{className:"text-sm font-semibold text-red-700 bg-red-50 px-2 py-1 rounded border border-red-200 block text-center h-10 flex items-center justify-center",title:"Last Purchase Price",children:w!==null?`$${Math.round(w)}`:p?"N/A":"$0"})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Rate"}),e.jsx("input",{type:"number",step:"1",value:d,onChange:m=>y(m.target.value),onKeyDown:Pe,onFocus:m=>m.target.select(),className:"input text-center",placeholder:"0 (Enter to add & focus search)",required:!0})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Amount"}),e.jsx("span",{className:"text-sm font-semibold text-gray-700 bg-gray-100 px-2 py-1 rounded border border-gray-200 block text-center h-10 flex items-center justify-center",children:b?Math.round(q*parseInt(d||0)):0})]}),e.jsx("div",{className:"col-span-1 flex items-end",children:e.jsxs(xe,{type:"button",onClick:Le,isLoading:$,className:"w-full btn btn-primary flex items-center justify-center px-3 py-2",disabled:!p||$,title:"Add to cart (or press Enter in Quantity/Rate fields - focus returns to search)",children:[e.jsx(Nt,{className:"h-4 w-4 mr-2"}),"Add"]})})]})}),e.jsx(_s,{isOpen:W,onClose:()=>M(!1),onScan:m=>{const V=ie.find(U=>U.barcode===m||U.sku===m);V?(ye(V),se.success(`Product found: ${V.name}`)):(H(m),se.info(`Searching for: ${m}`)),M(!1)},scanMode:"both"})]})},Sr=({tabId:k,editData:o})=>{const[g,E]=n.useState(null),[x,j]=n.useState([]),[r,T]=n.useState(null),[H,p]=n.useState(""),[P,q]=n.useState("cash"),[D,d]=n.useState(""),[y,B]=n.useState(0),[u,b]=n.useState(!1),[_,$]=n.useState(!1),[F,l]=n.useState(null),[v,w]=n.useState([]),[O,W]=n.useState(!0),[M,z]=n.useState({type:"amount",value:0}),[S,Q]=n.useState(!1),[I,ce]=n.useState(""),[ge,pe]=n.useState(!0),[ie,be]=n.useState(""),[we,ye]=n.useState(!1),[Le,Pe]=n.useState(!1),[He,Te]=n.useState(!1),[m,V]=n.useState({}),[U,X]=n.useState({}),[Se,le]=n.useState(!1),[K,oe]=n.useState({}),[de,wt]=n.useState(!1),[Z,Ce]=n.useState({}),[Ve,st]=n.useState("wholesale"),[Pt,Ie]=n.useState(!1),[ee,Be]=n.useState("pdf"),[Ye,rt]=n.useState(!1),ue=(()=>{const t=new Date,s=new Date;s.setMonth(t.getMonth()-1);const a=i=>{const c=i.getFullYear(),h=String(i.getMonth()+1).padStart(2,"0"),C=String(i.getDate()).padStart(2,"0");return`${c}-${h}-${C}`};return{from:a(s),to:a(t)}})(),[ke,Fe]=n.useState(ue.from),[Oe,qe]=n.useState(ue.to),{isMobile:_e}=Ze(),{trackProductView:St}=Vs(),{updateTabTitle:at,getActiveTab:nt,openTab:Ct}=ns(),{hasPermission:$e,user:We}=cs(),[ct,kt]=n.useState(!1),ot=n.useMemo(()=>!Array.isArray(x)||x.length===0?0:x.reduce((t,s)=>{var f,G,R;if(!(s!=null&&s.product))return t;const a=s.product._id,i=Number(s.quantity)||0,c=Number(s.unitPrice)||0,C=(a&&Z[a]!==void 0?Number(Z[a]):null)??Number((f=s.product.pricing)==null?void 0:f.cost)??Number((G=s.product.pricing)==null?void 0:G.purchasePrice)??Number((R=s.product.pricing)==null?void 0:R.wholesaleCost)??0,Y=(c-(Number.isFinite(C)?C:0))*i;return t+(Number.isFinite(Y)?Y:0)},0),[x,Z]),ze=t=>{if(!t)return"";const s=new Date,a=s.getFullYear(),i=String(s.getMonth()+1).padStart(2,"0"),c=String(s.getDate()).padStart(2,"0"),h=String(s.getTime()).slice(-4);return`INV-${t.displayName.split(" ").map(N=>N.charAt(0).toUpperCase()).join("").substring(0,3)}-${a}${i}${c}-${h}`};n.useEffect(()=>{if(o&&o.isEditMode&&o.orderId){if(o.customer&&T(o.customer),o.orderNumber&&(ce(o.orderNumber),pe(!1)),o.notes&&be(o.notes),o.items&&o.items.length>0){const t=o.items.map(s=>{var a,i,c,h;return{product:s.product,quantity:s.quantity,unitPrice:s.unitPrice||s.price||((i=(a=s.product)==null?void 0:a.pricing)==null?void 0:i.retail)||0,totalPrice:s.totalPrice||s.quantity*(s.unitPrice||s.price||((h=(c=s.product)==null?void 0:c.pricing)==null?void 0:h.retail)||0)}});j(t)}o.isTaxExempt!==void 0&&W(o.isTaxExempt),o.payment&&(q(o.payment.method||"cash"),B(o.payment.amount||0),o.payment.method==="bank"?d(o.payment.bankAccount||""):d("")),o.orderType}},[o==null?void 0:o.orderId]);const{data:he,isLoading:it}=gs({isActive:!0},{staleTime:5*6e4}),{data:ae,isLoading:_t,refetch:je}=os({limit:1e3},{staleTime:0,refetchOnMountOrArgChange:!0}),[$t]=yt(),[At]=jt(),[Mt,{isLoading:Rt}]=is(),[Et,{isLoading:Lt}]=ls(),Ae=n.useMemo(()=>{var t;return((t=ae==null?void 0:ae.data)==null?void 0:t.customers)||(ae==null?void 0:ae.customers)||(ae==null?void 0:ae.data)||ae||[]},[ae]),Me=n.useMemo(()=>{var s;return(((s=he==null?void 0:he.data)==null?void 0:s.banks)||(he==null?void 0:he.banks)||[]).filter(a=>a.isActive!==!1)},[he]);n.useEffect(()=>{if(P==="bank"&&!D){const t=Me.find(s=>s==null?void 0:s.isDefault)||Me[0];t!=null&&t._id&&d(t._id)}},[P,D,Me]),n.useEffect(()=>{if(r&&Ae&&Ae.length>0){const t=Ae.find(s=>s._id===r._id);t&&(t.pendingBalance!==r.pendingBalance||t.advanceBalance!==r.advanceBalance||t.currentBalance!==r.currentBalance)&&T(t)}},[Ae]);const ve=x.reduce((t,s)=>t+s.unitPrice*s.quantity,0),Tt=v.reduce((t,s)=>t+s.amount,0);let De=0;M.value>0&&(M.type==="percentage"?De=ve*M.value/100:De=Math.min(M.value,ve));const Re=Tt+De,lt=ve-Re,Ue=O?0:lt*.08,ne=lt+Ue,Qe=t=>t?t==="retail"||t==="wholesale"?t:t==="distributor"?"wholesale":"retail":"retail",It=async t=>{T(t),X({}),le(!1),oe({}),ge&&t&&ce(ze(t));const s=nt();s&&t&&at(s.id,`Sales - ${t.displayName}`)};n.useEffect(()=>{},[Ve]),n.useEffect(()=>{(async()=>{if(x.length===0)return;const s=x.map(a=>a.product._id);if(s.length!==0)try{const a=await At({productIds:s}).unwrap();if(a&&a.prices){const i={};Object.keys(a.prices).forEach(c=>{i[c]=a.prices[c].lastPurchasePrice}),Ce(c=>({...c,...i}))}}catch{}})()},[x]);const dt=async t=>{j(s=>{var i;const a=s.find(c=>c.product._id===t.product._id);if(a){const c=a.quantity+t.quantity,h=((i=t.product.inventory)==null?void 0:i.currentStock)||0;return c>h?(se.error(`Cannot add ${t.quantity} more units. Only ${h-a.quantity} additional units available (${a.quantity} already in cart).`),s):s.map(N=>N.product._id===t.product._id?{...N,quantity:N.quantity+t.quantity,unitPrice:t.unitPrice}:N)}return t.product._id&&$t(t.product._id).unwrap().then(c=>{c&&c.lastPurchasePrice!==null&&Ce(h=>({...h,[t.product._id]:c.lastPurchasePrice}))}).catch(()=>{}),[...s,t]})},Bt=async(t,s)=>{if(s<=0){ut(t);return}j(a=>{var h;const i=a.find(C=>C.product._id===t);if(!i)return a;const c=((h=i.product.inventory)==null?void 0:h.currentStock)||0;return s>c?(se.error(`Cannot set quantity to ${s}. Only ${c} units available in stock.`),a):a.map(C=>C.product._id===t?{...C,quantity:s}:C)})},Ft=(t,s)=>{if(s<0)return;if(x.find(i=>i.product._id===t)){const i=Z[t];if(i!==void 0&&s<i){const c=i-s,h=(c/i*100).toFixed(1);se.error(`Warning: Sale price ($${s}) is below cost price ($${Math.round(i)}). Loss: $${Math.round(c)} (${h}%)`,{duration:5e3,position:"top-center",icon:"⚠️"})}}j(i=>i.map(c=>c.product._id===t?{...c,unitPrice:s}:c))},ut=t=>{j(s=>{const a=s.filter(i=>i.product._id!==t);return a.length===0?(X({}),le(!1),oe({})):(X(i=>{const c={...i};return delete c[t.toString()],Object.keys(c).length===0&&(le(!1),oe({})),c}),oe(i=>{const c={...i};return delete c[t.toString()],c})),a})},Ot=()=>{j(t=>{if(!t||t.length<2)return t;const s=i=>{const c=i.product;return c?typeof c=="string"?c:c.name||c.title||c.displayName||c.businessName||c.fullName||"":""};return[...t].sort((i,c)=>{const h=s(i).toString().toLowerCase(),C=s(c).toString().toLowerCase();return h<C?-1:h>C?1:0})})},qt=async()=>{if(!r){L("Please select a customer first");return}if(x.length===0){L("Please add products to cart first");return}ye(!0);try{const t=await salesAPI.getLastPrices(r._id),{prices:s,orderNumber:a,orderDate:i}=t.data;if(!s||Object.keys(s).length===0){L("No previous order found for this customer"),ye(!1);return}const c={},h={};x.forEach(R=>{const A=R.product._id.toString();c[A]=R.unitPrice}),X(c);let C=0,N=0,Y=0;const f=x.map(R=>{const A=R.product._id.toString();if(s[A]){const J=s[A].unitPrice,fe=R.unitPrice;return J!==fe?(C++,h[A]="updated",{...R,unitPrice:J}):(N++,h[A]="unchanged",R)}else return Y++,h[A]="not-found",R});j(f),oe(h),le(!0);const G=i?new Date(i).toLocaleDateString():"previous order";if(C>0){let R=`Applied prices from ${a||"previous order"} (${G}). Updated ${C} product(s).`;N>0&&(R+=` ${N} product(s) had same price.`),Y>0&&(R+=` ${Y} product(s) not found in previous order.`),te(R)}else N>0?te(`All products already have the same prices as in ${a||"previous order"} (${G}).`):L("No matching products found in previous order")}catch(t){re(t,"Apply Last Prices")}finally{ye(!1)}},Dt=()=>{if(Object.keys(U).length===0){L("No original prices to restore");return}Pe(!0);try{let t=0;const s=x.map(a=>{const i=a.product._id.toString();return U[i]!==void 0?(t++,{...a,unitPrice:U[i]}):a});j(s),le(!1),X({}),oe({}),t>0?te(`Restored original prices for ${t} product(s).`):L("No matching products found to restore")}finally{Pe(!1)}},{confirmation:Ut,confirmClear:Gt,handleConfirm:Ht,handleCancel:Vt}=vs(),Yt=()=>{x.length>0&&(Te(!0),Gt(x.length,"items",async()=>{try{j([]),T(null),p(""),w([]),W(!0),z({type:"amount",value:0}),Q(!1),ce(""),q("cash"),d(""),B(0),X({}),le(!1),oe({}),st("wholesale");const t=nt();t&&at(t.id,"Sales"),se.success("Cart cleared")}finally{Te(!1)}}))},Wt=()=>{Ie(!0)},zt=async()=>{var t,s,a,i;rt(!0);try{const c={...(r==null?void 0:r._id)&&{customer:r._id},...ke&&{dateFrom:ke},...Oe&&{dateTo:Oe}};let h;if(ee==="excel"?h=await salesAPI.exportExcel(c):ee==="csv"?h=await salesAPI.exportCSV(c):ee==="json"?h=await salesAPI.exportJSON(c):ee==="pdf"&&(h=await salesAPI.exportPDF(c)),(t=h==null?void 0:h.data)!=null&&t.filename){const C=h.data.filename;try{ee==="pdf"&&await new Promise(f=>setTimeout(f,500));let N;try{N=await salesAPI.downloadFile(C)}catch(f){if(f.response){const G=f.response.data;if(G instanceof Blob){const R=new FileReader;R.onload=()=>{const A=R.result;try{const J=JSON.parse(A);L(J.message||`Download failed: ${f.response.status}`)}catch{L(`Download failed: ${f.response.status}`)}},R.readAsText(G)}else typeof G=="object"&&G!==null?L(G.message||`Download failed: ${f.response.status}`):L(`Download failed: ${f.response.status}`)}else L("Download failed: "+(f.message||"Network error"));return}if(!N){L("Download failed: No response received");return}if(N.status!==200){L(`Download failed with status ${N.status}`);return}if(!N.data){L("Download failed: No data received from server");return}const Y=((s=N.headers)==null?void 0:s["content-type"])||((a=N.headers)==null?void 0:a["Content-Type"])||"";if(ee==="pdf"){const f=N.data;if(!f||!(f instanceof Blob)){if(typeof f=="string")L(`Server error: ${f.substring(0,100)}`);else if(f&&typeof f=="object"){let A=f.message||f.error;if(!A)try{const J=JSON.stringify(f);J==="{}"||J==="null"||J===""?A=f.statusText||f.status||"Unknown server error":A=J.substring(0,150)}catch{A="Invalid response format"}L(`Server error: ${A||"Unknown error"}`)}else L("Invalid PDF file received - expected Blob. Response type: "+typeof f);return}if(Y.includes("application/json")||Y.includes("text/html")){const A=new FileReader;A.onload=()=>{const J=A.result;try{const fe=JSON.parse(J);L(fe.message||"File not found or generation failed")}catch{L("Server returned error instead of PDF. Please try again.")}},A.readAsText(f);return}if(f.size===0){L("PDF file is empty");return}if(f.type&&!f.type.includes("pdf")&&!f.type.includes("application/octet-stream")){const A=new FileReader;A.onload=()=>{const J=A.result;if(J.includes("<!DOCTYPE")||J.includes('{"error"')||J.includes('{"message"'))L("Server returned an error instead of PDF file");else{const fe=URL.createObjectURL(f);if(window.open(fe,"_blank"))te("PDF opened in new tab");else{const Ee=document.createElement("a");Ee.href=fe,Ee.download=C,document.body.appendChild(Ee),Ee.click(),document.body.removeChild(Ee),te("PDF downloaded (popup was blocked)")}setTimeout(()=>URL.revokeObjectURL(fe),1e4)}},A.readAsText(f.slice(0,100));return}const G=URL.createObjectURL(f);if(window.open(G,"_blank"))te("PDF opened in new tab");else{const A=document.createElement("a");A.href=G,A.download=C,document.body.appendChild(A),A.click(),document.body.removeChild(A),te("PDF downloaded (popup was blocked)")}setTimeout(()=>URL.revokeObjectURL(G),1e4)}else{const f=new Blob([N.data],{type:ee==="excel"?"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":ee==="csv"?"text/csv":"application/json"}),G=URL.createObjectURL(f),R=document.createElement("a");R.href=G,R.download=C,document.body.appendChild(R),R.click(),document.body.removeChild(R),URL.revokeObjectURL(G),te(`${ee.toUpperCase()} file downloaded successfully`)}}catch(N){if(N.response)if(N.response.data instanceof Blob){const Y=new FileReader;Y.onload=()=>{const f=Y.result;try{const G=JSON.parse(f);L(G.message||"Download failed")}catch{L("Download failed: "+f.substring(0,100))}},Y.readAsText(N.response.data)}else L(((i=N.response.data)==null?void 0:i.message)||`Download failed: ${N.response.status}`);else L("Download failed: "+(N.message||"Unknown error"));return}}Ie(!1)}catch(c){re(c,"Export")}finally{rt(!1)}},Qt=async t=>{try{const s=await Mt({payload:t}).unwrap();if(te("Sale created successfully"),g&&typeof g=="function")try{g()}catch(a){console.warn("Failed to refetch products:",a)}if(je&&typeof je=="function")try{je()}catch(a){console.warn("Failed to refetch customers:",a)}j([]),B(0),w([]),z({type:"amount",value:0}),be(""),ce(""),Ce({}),X({}),le(!1),oe({}),s!=null&&s.order&&(l(s.order),$(!0))}catch(s){re(s,"Create Sale")}},Jt=async(t,s)=>{try{const a=await Et({id:t,...s}).unwrap();if(te("Order updated successfully"),g&&typeof g=="function")try{g()}catch(i){console.warn("Failed to refetch products:",i)}if(je&&typeof je=="function")try{je()}catch(i){console.warn("Failed to refetch customers:",i)}j([]),B(0),w([]),z({type:"amount",value:0}),be(""),ce(""),Ce({}),X({}),le(!1),oe({}),a!=null&&a.order&&(l(a.order),$(!0))}catch(a){re(a,"Update Order")}},Kt=()=>{if(x.length===0){L({message:"Cart is empty"});return}if(r&&r.creditLimit>0){const s=P||"cash",i=ne-(y||0);if(s==="account"||i>0){const c=r.currentBalance||0,h=r.pendingBalance||0,C=c+h,N=C+i,Y=r.creditLimit-C;if(N>r.creditLimit){const f=`Credit limit exceeded for ${r.displayName||r.name}. Current balance: $${C.toFixed(2)}, Unpaid amount: $${i.toFixed(2)}, Credit limit: $${r.creditLimit.toFixed(2)}, Available credit: $${Y.toFixed(2)}. Please collect payment or reduce the order amount.`;se.error(f,{duration:8e3,position:"top-center"});return}else if(Y-i<r.creditLimit*.1){const f=`Warning: ${r.displayName||r.name} is near credit limit. Available credit: $${Y.toFixed(2)}, After this order: $${(Y-i).toFixed(2)} remaining.`;se.warning(f,{duration:6e3,position:"top-center"})}}}if(P==="bank"&&!D){L({message:"Please select a bank account for bank payments"});return}const t={orderType:Qe(r==null?void 0:r.businessType),customer:r==null?void 0:r._id,items:x.map(s=>({product:s.product._id,quantity:s.quantity,unitPrice:s.unitPrice})),appliedDiscounts:v,directDiscount:M,subtotal:ve,discountAmount:Re,tax:Ue,isTaxExempt:O,total:ne,invoiceNumber:I,notes:(ie==null?void 0:ie.trim())||"",payment:{method:P,bankAccount:P==="bank"?D:null,amount:y,remainingBalance:ne-y,isPartialPayment:y<ne,isAdvancePayment:S,advanceAmount:S?y-ne:0}};if(o!=null&&o.isEditMode){const s=o.orderId,a={orderType:Qe(r==null?void 0:r.businessType),customer:r==null?void 0:r._id,items:x.map(i=>{const c=i.quantity*i.unitPrice,h=0,C=0,N=c-h+C;return{product:i.product._id,quantity:i.quantity,unitPrice:i.unitPrice,discountPercent:0,taxRate:0,subtotal:c,discountAmount:h,taxAmount:C,total:N}}),notes:ie||""};Jt(s,a)}else Qt(t)},Xt=async t=>{},Zt=t=>{re(t,"Payment processing"),b(!1),l(null)};return e.jsxs(ys,{children:[e.jsxs("div",{className:"space-y-4 lg:space-y-6",children:[e.jsxs("div",{className:`flex ${_e?"flex-col space-y-4":"items-start justify-between"}`,children:[e.jsxs("div",{children:[e.jsx("h1",{className:`${_e?"text-xl":"text-2xl"} font-bold text-gray-900`,children:"Point of Sale"}),e.jsx("p",{className:"text-gray-600",children:"Process sales transactions"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("button",{onClick:Wt,className:"btn btn-secondary btn-md",title:"Export Sales Report",children:[e.jsx(xt,{className:"h-4 w-4 mr-2"}),"Export Sales Report"]}),e.jsxs("button",{onClick:()=>{const t=Cs("/sales");if(t){const s=`tab_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;Ct({title:"Sales",path:"/sales",component:t.component,icon:t.icon,allowMultiple:!0,props:{tabId:s}})}},className:"btn btn-primary btn-md",children:[e.jsx(Nt,{className:"h-4 w-4 mr-2"}),"New Sales"]})]})]}),e.jsxs("div",{className:`flex ${_e?"flex-col space-y-4":"items-start space-x-4"}`,children:[e.jsxs("div",{className:`${_e?"w-full":"w-[500px] flex-shrink-0"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Select Customer"}),r&&e.jsx("button",{onClick:()=>{T(null),p("")},className:"text-xs text-blue-600 hover:text-blue-800 underline",title:"Change customer",children:"Change Customer"})]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("label",{className:"text-xs font-normal text-gray-400",children:"Price Type:"}),e.jsxs("select",{value:Ve,onChange:t=>st(t.target.value),className:"border border-gray-200 rounded-md px-2 py-1 text-xs text-gray-600 focus:outline-none focus:ring-1 focus:ring-primary-400 focus:border-primary-400",children:[e.jsx("option",{value:"wholesale",children:"Wholesale"}),e.jsx("option",{value:"retail",children:"Retail"}),e.jsx("option",{value:"custom",children:"Custom"})]})]})})]}),e.jsx(vt,{placeholder:"Search customers by name, email, or business...",items:Ae||[],onSelect:It,onSearch:p,selectedItem:r,displayKey:t=>{const s=t.pendingBalance||0,a=t.advanceBalance||0,i=s-a,c=i<0,h=s>0||a>0;return e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.displayName}),h?e.jsxs("div",{className:`text-sm ${c?"text-red-600":"text-green-600"}`,children:[c?"Advance:":"Receivables:"," $",Math.abs(i).toFixed(2)]}):null]})},loading:_t,emptyMessage:"No customers found"})]}),e.jsx("div",{className:`${_e?"w-full":"flex-1"}`,children:r?e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ds,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:r.displayName}),e.jsxs("p",{className:"text-sm text-gray-600 capitalize",children:[r.businessType," • ",r.phone||"No phone"]}),e.jsxs("div",{className:"flex items-center space-x-4 mt-2",children:[(()=>{const t=r.pendingBalance||0,s=r.advanceBalance||0,a=t-s,i=a<0,c=a>0;return t>0||s>0?e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:"text-xs text-gray-500",children:i?"Advance:":"Receivables:"}),e.jsxs("span",{className:`text-sm font-medium ${i?"text-red-600":c?"text-green-600":"text-gray-600"}`,children:["$",Math.abs(a).toFixed(2)]})]}):null})(),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Credit Limit:"}),e.jsxs("span",{className:`text-sm font-medium ${r.creditLimit>0?(r.currentBalance||0)+(r.pendingBalance||0)>=r.creditLimit*.9?"text-red-600":(r.currentBalance||0)+(r.pendingBalance||0)>=r.creditLimit*.7?"text-yellow-600":"text-blue-600":"text-gray-600"}`,children:["$",(r.creditLimit||0).toFixed(2)]}),r.creditLimit>0&&(r.currentBalance||0)+(r.pendingBalance||0)>=r.creditLimit*.9&&e.jsx("span",{className:"text-xs text-red-600 font-bold ml-1",children:"⚠️"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Available Credit:"}),e.jsxs("span",{className:`text-sm font-medium ${r.creditLimit>0?r.creditLimit-((r.currentBalance||0)+(r.pendingBalance||0))<=r.creditLimit*.1?"text-red-600":r.creditLimit-((r.currentBalance||0)+(r.pendingBalance||0))<=r.creditLimit*.3?"text-yellow-600":"text-green-600":"text-gray-600"}`,children:["$",(r.creditLimit-((r.currentBalance||0)+(r.pendingBalance||0))).toFixed(2)]})]})]})]})]})}):e.jsx("div",{className:"hidden lg:block"})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Product Selection & Cart"}),e.jsxs("div",{className:"flex flex-wrap items-center justify-start lg:justify-end gap-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>wt(!de),className:"btn btn-secondary btn-sm flex items-center space-x-2",title:de?"Hide purchase cost prices":"Show purchase cost prices",children:de?e.jsxs(e.Fragment,{children:[e.jsx($s,{className:"h-4 w-4"}),e.jsx("span",{children:"Hide Cost"})]}):e.jsxs(e.Fragment,{children:[e.jsx(tt,{className:"h-4 w-4"}),e.jsx("span",{children:"Show Cost"})]})}),(We==null?void 0:We.role)==="admin"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>kt(t=>!t),className:"btn btn-secondary btn-sm flex items-center space-x-2",title:"Show estimated profit (BP)",children:[e.jsx(As,{className:"h-4 w-4"}),e.jsx("span",{children:ct?"Hide BP":"Show BP"})]}),ct&&e.jsx("span",{className:`text-sm font-semibold ${ot>=0?"text-green-600":"text-red-600"}`,children:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(ot||0)})]})]}),r&&x.length>0&&e.jsx(e.Fragment,{children:Se?e.jsxs(xe,{onClick:Dt,isLoading:Le,className:"btn btn-secondary btn-sm flex items-center space-x-2",title:"Restore original/current prices",children:[e.jsx(us,{className:"h-4 w-4"}),e.jsx("span",{children:"Restore Current Prices"})]}):e.jsxs(xe,{onClick:qt,isLoading:we,className:"btn btn-secondary btn-sm",title:"Apply prices from last order for this customer",children:[e.jsx(Ms,{className:"h-4 w-4 mr-2"}),"Apply Last Prices"]})})]})]})}),e.jsxs("div",{className:"card-content",children:[e.jsx("div",{className:"mb-6",children:e.jsx(Ys,{onAddProduct:dt,selectedCustomer:r,showCostPrice:de,hasCostPricePermission:$e("view_cost_prices"),priceType:Ve,onRefetchReady:E,onLastPurchasePriceFetched:(t,s)=>{Ce(a=>({...a,[t]:s}))}})}),x.length===0?e.jsxs("div",{className:"p-8 text-center text-gray-500 border-t border-gray-200",children:[e.jsx(et,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("p",{className:"mt-2",children:"No items in cart"})]}):e.jsxs("div",{className:"space-y-4 border-t border-gray-200 pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"text-md font-medium text-gray-700",children:"Cart Items"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("button",{type:"button",onClick:Ot,className:"btn btn-secondary btn-sm flex items-center space-x-2",title:"Sort products alphabetically",children:[e.jsx(ms,{className:"h-4 w-4"}),e.jsx("span",{children:"Sort A-Z"})]}),Se&&Object.keys(K).length>0&&e.jsxs("div",{className:"flex items-center space-x-3 text-xs",children:[e.jsx("span",{className:"text-gray-600 font-medium",children:"Price Status:"}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(pt,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"Updated"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ht,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"Same Price"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(me,{className:"h-3 w-3 text-yellow-600"}),e.jsx("span",{className:"text-gray-600",children:"Not in Last Order"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-12 gap-4 items-center pb-2 border-b border-gray-300 mb-2",children:[e.jsx("div",{className:"col-span-1",children:e.jsx("span",{className:"text-xs font-semibold text-gray-600 uppercase",children:"#"})}),e.jsx("div",{className:`${de&&$e("view_cost_prices")?"col-span-5":"col-span-6"}`,children:e.jsx("span",{className:"text-xs font-semibold text-gray-600 uppercase",children:"Product"})}),e.jsx("div",{className:"col-span-1",children:e.jsx("span",{className:"text-xs font-semibold text-gray-600 uppercase",children:"Stock"})}),e.jsx("div",{className:"col-span-1",children:e.jsx("span",{className:"text-xs font-semibold text-gray-600 uppercase",children:"Qty"})}),de&&$e("view_cost_prices")&&e.jsx("div",{className:"col-span-1",children:e.jsx("span",{className:"text-xs font-semibold text-gray-600 uppercase",children:"Cost"})}),e.jsx("div",{className:"col-span-1",children:e.jsx("span",{className:"text-xs font-semibold text-gray-600 uppercase",children:"Rate"})}),e.jsx("div",{className:"col-span-1",children:e.jsx("span",{className:"text-xs font-semibold text-gray-600 uppercase",children:"Total"})}),e.jsx("div",{className:"col-span-1",children:e.jsx("span",{className:"text-xs font-semibold text-gray-600 uppercase",children:"Action"})})]}),x.map((t,s)=>{var c,h,C,N,Y,f,G,R;const a=t.unitPrice*t.quantity,i=((c=t.product.inventory)==null?void 0:c.currentStock)<=((h=t.product.inventory)==null?void 0:h.reorderPoint);return e.jsx("div",{className:`py-1 ${s%2===0?"bg-white":"bg-gray-50"}`,children:e.jsxs("div",{className:"grid grid-cols-12 gap-4 items-center",children:[e.jsx("div",{className:"col-span-1",children:e.jsx("span",{className:"text-sm font-medium text-gray-700 bg-gray-50 px-0.5 py-1 rounded border border-gray-200 block text-center h-8 flex items-center justify-center",children:s+1})}),e.jsx("div",{className:`${de&&$e("view_cost_prices")?"col-span-5":"col-span-6"} flex items-center h-8`,children:e.jsxs("span",{className:"font-medium text-sm truncate",children:[t.product.name,i&&e.jsx("span",{className:"text-yellow-600 text-xs ml-2",children:"⚠️ Low Stock"}),Z[t.product._id]!==void 0&&t.unitPrice<Z[t.product._id]&&e.jsx("span",{className:"text-xs ml-2 px-1.5 py-0.5 rounded bg-red-100 text-red-700 font-bold",title:`Sale price below cost! Loss: $${Math.round(Z[t.product._id]-t.unitPrice)} per unit`,children:"⚠️ Loss"}),Se&&K[t.product._id]&&e.jsx("span",{className:`text-xs ml-2 px-1.5 py-0.5 rounded ${K[t.product._id]==="updated"?"bg-green-100 text-green-700":K[t.product._id]==="unchanged"?"bg-blue-100 text-blue-700":"bg-yellow-100 text-yellow-700"}`,children:K[t.product._id]==="updated"?"Updated":K[t.product._id]==="unchanged"?"Same Price":"Not in Last Order"})]})}),e.jsx("div",{className:"col-span-1",children:e.jsx("span",{className:`text-sm font-semibold px-2 py-1 rounded border block text-center h-8 flex items-center justify-center ${(((C=t.product.inventory)==null?void 0:C.currentStock)||0)===0?"text-red-700 bg-red-50 border-red-200":(((N=t.product.inventory)==null?void 0:N.currentStock)||0)<=(((Y=t.product.inventory)==null?void 0:Y.reorderPoint)||0)?"text-yellow-700 bg-yellow-50 border-yellow-200":"text-gray-700 bg-gray-100 border-gray-200"}`,children:((f=t.product.inventory)==null?void 0:f.currentStock)||0})}),e.jsx("div",{className:"col-span-1",children:e.jsx("input",{type:"number",value:t.quantity,onChange:A=>Bt(t.product._id,parseInt(A.target.value)||1),className:"input text-center h-8",min:"1",max:((G=t.product.inventory)==null?void 0:G.currentStock)||999999,title:`Maximum available: ${((R=t.product.inventory)==null?void 0:R.currentStock)||0}`})}),de&&$e("view_cost_prices")&&e.jsx("div",{className:"col-span-1",children:e.jsx("span",{className:"text-sm font-semibold text-red-700 bg-red-50 px-2 py-1 rounded border border-red-200 block text-center h-8 flex items-center justify-center",title:"Last Purchase Price",children:Z[t.product._id]!==void 0?`$${Math.round(Z[t.product._id])}`:"N/A"})}),e.jsxs("div",{className:"col-span-1 relative",children:[e.jsx("input",{type:"number",step:"1",value:Math.round(t.unitPrice),onChange:A=>Ft(t.product._id,parseInt(A.target.value)||0),className:`input text-center h-8 ${Z[t.product._id]!==void 0&&t.unitPrice<Z[t.product._id]?"bg-red-50 border-red-400 ring-2 ring-red-300":K[t.product._id]==="updated"?"bg-green-50 border-green-300 ring-1 ring-green-200":K[t.product._id]==="not-found"?"bg-yellow-50 border-yellow-300 ring-1 ring-yellow-200":K[t.product._id]==="unchanged"?"bg-blue-50 border-blue-300 ring-1 ring-blue-200":""}`,min:"0",title:Z[t.product._id]!==void 0&&t.unitPrice<Z[t.product._id]?`⚠️ WARNING: Sale price ($${Math.round(t.unitPrice)}) is below cost price ($${Math.round(Z[t.product._id])})`:""}),Se&&K[t.product._id]&&e.jsxs("div",{className:"absolute -right-7 top-1/2 transform -translate-y-1/2 flex items-center z-10",title:K[t.product._id]==="updated"?"Price updated from last order":K[t.product._id]==="unchanged"?"Price same as last order":"Product not found in previous order",children:[K[t.product._id]==="updated"&&e.jsx(pt,{className:"h-4 w-4 text-green-600 bg-white rounded-full"}),K[t.product._id]==="unchanged"&&e.jsx(ht,{className:"h-4 w-4 text-blue-600 bg-white rounded-full"}),K[t.product._id]==="not-found"&&e.jsx(me,{className:"h-4 w-4 text-yellow-600 bg-white rounded-full"})]})]}),e.jsx("div",{className:"col-span-1",children:e.jsx("span",{className:"text-sm font-semibold text-gray-700 bg-gray-100 px-2 py-1 rounded border border-gray-200 block text-center h-8 flex items-center justify-center",children:Math.round(a)})}),e.jsx("div",{className:"col-span-1",children:e.jsx(xe,{onClick:()=>ut(t.product._id),isLoading:m[t.product._id],className:"btn btn-danger btn-sm h-8 w-full",children:e.jsx(ft,{className:"h-4 w-4"})})})]})},t.product._id)})]})]})]}),x.length>0&&e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg max-w-5xl ml-auto mt-4",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-blue-200",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 text-right mb-4",children:"Sales Details"}),e.jsxs("div",{className:"flex flex-nowrap gap-3 items-end justify-end",children:[e.jsxs("div",{className:"flex flex-col w-44",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Order Type"}),e.jsxs("select",{value:(r==null?void 0:r.businessType)||"wholesale",className:"input h-8 text-sm",disabled:!0,children:[e.jsx("option",{value:"retail",children:"Retail"}),e.jsx("option",{value:"wholesale",children:"Wholesale"}),e.jsx("option",{value:"return",children:"Return"}),e.jsx("option",{value:"exchange",children:"Exchange"})]})]}),e.jsxs("div",{className:"flex flex-col w-40",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Tax Status"}),e.jsxs("div",{className:"flex items-center space-x-1 px-2 py-1 border border-gray-200 rounded h-8",children:[e.jsx("input",{type:"checkbox",id:"taxExempt",checked:O,onChange:t=>W(t.target.checked),className:"h-3 w-3 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"}),e.jsx("div",{className:"flex-1",children:e.jsx("label",{htmlFor:"taxExempt",className:"text-xs font-medium text-gray-700 cursor-pointer",children:"Tax Exempt"})}),O&&e.jsx("div",{className:"text-green-600 text-xs font-medium",children:"✓"})]})]}),e.jsxs("div",{className:"flex flex-col w-72",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-1",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 m-0",children:"Invoice Number"}),e.jsxs("label",{htmlFor:"autoGenerateInvoice",className:"flex items-center space-x-1 text-[11px] text-gray-600 cursor-pointer select-none",children:[e.jsx("input",{type:"checkbox",id:"autoGenerateInvoice",checked:ge,onChange:t=>{pe(t.target.checked),t.target.checked&&r&&ce(ze(r))},className:"h-3 w-3 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"}),e.jsx("span",{children:"Auto-generate"})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:I,onChange:t=>ce(t.target.value),className:"w-full input pr-16 h-8 text-sm",placeholder:ge?"Auto-generated":"Enter invoice number",disabled:ge}),ge&&e.jsx("button",{type:"button",onClick:()=>{r&&ce(ze(r))},className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-[11px] text-primary-600 hover:text-primary-800 font-medium",children:"Regenerate"})]})]}),e.jsxs("div",{className:"flex flex-col w-[28rem]",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("input",{type:"text",value:ie,onChange:t=>be(t.target.value),className:"input h-8 text-sm",placeholder:"Additional notes..."})]})]})]}),e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4",children:e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Order Summary"})}),e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-800 font-semibold",children:"Subtotal:"}),e.jsx("span",{className:"text-xl font-bold text-gray-900",children:Math.round(ve)})]}),Re>0&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-800 font-semibold",children:"Discount:"}),e.jsxs("span",{className:"text-xl font-bold text-red-600",children:["-",Math.round(Re)]})]}),!O&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-800 font-semibold",children:"Tax (8%):"}),e.jsx("span",{className:"text-xl font-bold text-gray-900",children:Math.round(Ue)})]}),r&&(()=>{const t=r.pendingBalance||0,s=r.advanceBalance||0,a=t-s;return t>0||s>0?e.jsxs("div",{className:"flex justify-between items-center mt-2",children:[e.jsx("span",{className:"text-gray-800 font-semibold",children:a<0?"Previous Advance:":"Previous Receivables:"}),e.jsxs("span",{className:`text-xl font-bold ${a<0?"text-red-600":"text-green-600"}`,children:[a<0?"-":"+",Math.abs(Math.round(a))]})]}):null})(),e.jsxs("div",{className:"flex justify-between items-center text-xl font-bold border-t-2 border-blue-400 pt-3 mt-2",children:[e.jsx("span",{className:"text-blue-900",children:"Total:"}),e.jsx("span",{className:"text-blue-900 text-3xl",children:Math.round(ne)})]}),r&&(()=>{const t=r.pendingBalance||0,s=r.advanceBalance||0,a=t-s;if(!(t>0||s>0))return null;const c=ne+a,h=c<0;return e.jsxs("div",{className:"flex justify-between items-center text-lg font-bold border-t-2 border-red-400 pt-3 mt-2",children:[e.jsx("span",{className:h?"text-red-700":"text-green-700",children:h?"Total Advance:":"Total Receivables:"}),e.jsx("span",{className:`text-2xl ${h?"text-red-700":"text-green-700"}`,children:Math.abs(Math.round(c))})]})})()]}),e.jsxs("div",{className:"mt-4 bg-white rounded-lg p-4 shadow-sm",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-[minmax(0,2fr)_minmax(0,1fr)_minmax(0,1fr)] gap-4 items-start",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-800 mb-2",children:"Apply Discount"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("select",{value:M.type,onChange:t=>z({...M,type:t.target.value}),className:"px-3 py-2 border-2 border-blue-200 rounded-md bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium h-[42px]",children:[e.jsx("option",{value:"amount",children:"Amount"}),e.jsx("option",{value:"percentage",children:"%"})]}),e.jsx("input",{type:"number",placeholder:M.type==="amount"?"Enter amount...":"Enter percentage...",value:M.value||"",onChange:t=>{const s=parseInt(t.target.value)||0;z({...M,value:s})},className:"flex-1 px-3 py-2 border-2 border-blue-200 rounded-md bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium text-gray-900 h-[42px]",min:"0",step:(M.type==="percentage","1")})]}),M.value>0&&e.jsx("div",{className:"text-sm text-green-700 font-semibold mt-2 bg-green-50 px-2 py-1 rounded",children:M.type==="percentage"?`${M.value}% = ${Math.round(De)} off`:`${Math.round(M.value)} off`})]}),e.jsxs("div",{className:"flex flex-col md:col-start-2 md:row-start-1 w-full",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-800 mb-2",children:"Payment Method"}),e.jsxs("select",{value:P,onChange:t=>{const s=t.target.value;q(s),s!=="bank"&&d("")},className:"w-full px-3 py-2 border-2 border-blue-200 rounded-md bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium text-gray-900 h-[42px]",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"bank",children:"Bank Transfer"}),e.jsx("option",{value:"credit_card",children:"Credit Card"}),e.jsx("option",{value:"debit_card",children:"Debit Card"}),e.jsx("option",{value:"check",children:"Check"}),e.jsx("option",{value:"account",children:"Account"}),e.jsx("option",{value:"split",children:"Split Payment"})]}),P==="bank"&&e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Bank Account"}),e.jsxs("select",{value:D,onChange:t=>d(t.target.value),className:"w-full px-3 py-2 border-2 border-blue-200 rounded-md bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium text-gray-900 h-[42px]",children:[e.jsx("option",{value:"",children:"Select bank account..."}),Me.map(t=>e.jsxs("option",{value:t._id,children:[t.bankName," - ",t.accountNumber,t.accountName?` (${t.accountName})`:""]},t._id))]}),it&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Loading bank accounts..."}),!it&&Me.length===0&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"No bank accounts available. Add one in Banks."})]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-800 mb-2",children:"Amount Paid"}),e.jsx("input",{type:"number",step:"1",value:Math.round(y),onChange:t=>B(parseInt(t.target.value)||0),onFocus:t=>t.target.select(),className:"w-full px-3 py-2 border-2 border-blue-200 rounded-md bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium text-gray-900 text-lg h-[42px]",placeholder:"0"})]})]}),M.value>0&&e.jsx("div",{className:"mt-2",children:e.jsx("button",{onClick:()=>z({type:"amount",value:0}),className:"px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm",children:"Clear Discount"})})]}),e.jsxs("div",{className:"flex space-x-3 mt-6",children:[x.length>0&&e.jsxs(xe,{onClick:Yt,isLoading:He,className:"btn btn-secondary flex-1",children:[e.jsx(ft,{className:"h-4 w-4 mr-2"}),"Clear Cart"]}),x.length>0&&e.jsxs("button",{onClick:()=>{const t={orderNumber:`TEMP-${Date.now()}`,orderType:Qe(r==null?void 0:r.businessType),customer:r==null?void 0:r._id,customerInfo:r?{name:r.displayName,email:r.email,phone:r.phone,businessName:r.businessName}:null,items:x.map(s=>({product:{name:s.product.name},quantity:s.quantity,unitPrice:s.unitPrice})),pricing:{subtotal:ve,discountAmount:Re,taxAmount:Ue,isTaxExempt:O,total:ne},payment:{method:P,bankAccount:P==="bank"?D:null,amountPaid:y,remainingBalance:ne-y,isPartialPayment:y<ne,isAdvancePayment:S,advanceAmount:S?y-ne:0},createdAt:new Date,createdBy:{name:"Current User"},invoiceNumber:I};l(t),$(!0)},className:"btn btn-secondary flex-1",children:[e.jsx(Rs,{className:"h-4 w-4 mr-2"}),"Print Preview"]}),e.jsxs(xe,{onClick:Kt,isLoading:Rt||Lt,className:"btn btn-primary btn-lg flex-2",children:[e.jsx(xs,{className:"h-4 w-4 mr-2"}),o!=null&&o.isEditMode?y===0?"Update Invoice":"Update Sale":y===0?"Create Invoice":"Complete Sale"]})]})]})]}),x.length>0&&e.jsx("div",{className:"mt-4 max-w-5xl ml-auto",children:e.jsx(Us,{title:"Customers Also Bought",algorithm:"frequently_bought",context:{page:"sales",currentProducts:x.map(t=>t.product._id),customerTier:r==null?void 0:r.customerTier,businessType:r==null?void 0:r.businessType},limit:4,onAddToCart:dt,onViewProduct:t=>{St(t)}})})]}),e.jsx(js,{isOpen:Ut.isOpen,onClose:Vt,onConfirm:Ht,itemCount:x.length,itemType:"items",isLoading:!1}),e.jsx(Ts,{isOpen:u,onClose:()=>{b(!1),l(null)},orderData:F,onPaymentSuccess:Xt,onPaymentError:Zt}),e.jsx(ws,{isOpen:_,onClose:()=>{$(!1),l(null)},orderData:F,documentTitle:"Sales Invoice",partyLabel:"Customer"}),Pt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-lg w-full",children:[e.jsxs("div",{className:"flex justify-between items-center p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Export Sales Report"}),e.jsx("button",{onClick:()=>{Ie(!1),Fe(ue.from),qe(ue.to)},className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(Es,{className:"h-6 w-6"})})]}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Export Format"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("label",{className:"flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50",children:[e.jsx("input",{type:"radio",name:"format",value:"pdf",checked:ee==="pdf",onChange:t=>Be(t.target.value),className:"mr-3"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"PDF"}),e.jsx("div",{className:"text-sm text-gray-500",children:"Print-ready format"})]})]}),e.jsxs("label",{className:"flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50",children:[e.jsx("input",{type:"radio",name:"format",value:"excel",checked:ee==="excel",onChange:t=>Be(t.target.value),className:"mr-3"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"Excel"}),e.jsx("div",{className:"text-sm text-gray-500",children:"Spreadsheet format"})]})]}),e.jsxs("label",{className:"flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50",children:[e.jsx("input",{type:"radio",name:"format",value:"csv",checked:ee==="csv",onChange:t=>Be(t.target.value),className:"mr-3"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"CSV"}),e.jsx("div",{className:"text-sm text-gray-500",children:"Comma-separated values"})]})]}),e.jsxs("label",{className:"flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50",children:[e.jsx("input",{type:"radio",name:"format",value:"json",checked:ee==="json",onChange:t=>Be(t.target.value),className:"mr-3"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"JSON"}),e.jsx("div",{className:"text-sm text-gray-500",children:"Data format"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Date Range (Optional)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"From Date"}),e.jsx("input",{type:"date",value:ke,onChange:t=>Fe(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"To Date"}),e.jsx("input",{type:"date",value:Oe,onChange:t=>qe(t.target.value),min:ke,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"})]})]}),(ke||Oe)&&e.jsx("button",{type:"button",onClick:()=>{Fe(ue.from),qe(ue.to)},className:"mt-2 text-sm text-primary-600 hover:text-primary-700",children:"Reset to default"})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4 border-t border-gray-200",children:[e.jsx("button",{type:"button",onClick:()=>{Ie(!1),Fe(ue.from),qe(ue.to)},className:"btn btn-secondary",disabled:Ye,children:"Cancel"}),e.jsx("button",{type:"button",onClick:zt,className:"btn btn-primary",disabled:Ye,children:Ye?e.jsxs(e.Fragment,{children:[e.jsx(ps,{className:"h-4 w-4 mr-2"}),"Exporting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(xt,{className:"h-4 w-4 mr-2"}),"Export"]})})]})]})})]})})]})};export{Sr as Sales};
