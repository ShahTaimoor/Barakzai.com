import{E as lt,r as i,o as e,X as Tt,F as Rt,G as Oe,L as Ae,z as te,w as se,H as He,P as me,I as rt,s as Ve,J as ve,T as qe,c as It,R as De,K as Bt,M as Ft,u as Ot,a as Dt,U as qt,q as Ut,A as Ht,t as Vt,N as Yt,B as Ue,x as I,O as Gt,Q as X}from"./index-jd7Ax_Ed.js";import{u as Wt}from"./productsApi-hw6ecLPR.js";import"./banksApi-DQwHDPrA.js";import{u as zt}from"./useFuzzySearch-BrpeiQaU.js";import{S as dt}from"./SearchableDropdown-D6GNUAgH.js";import{A as Jt}from"./AsyncErrorBoundary-e71BFh1E.js";import{C as Kt}from"./ConfirmationDialog-EbANb_5f.js";import{u as Qt}from"./useConfirmation-BnXgMCcj.js";import{C as Xt}from"./check-C5eRyuMu.js";import{A as ie}from"./alert-circle-yrAHCiEw.js";import{P as Zt}from"./PrintModal-BkQ6aCj8.js";import{E as Ye}from"./eye-DMmE8Niy.js";import{H as es,S as $e}from"./sparkles-B3YVsjk1.js";import{S as ts}from"./star-DDOZYr3u.js";import{g as ss}from"./ComponentRegistry-COpHSNtL.js";import{C as rs,B as as}from"./BarcodeScanner-ClgolgQA.js";import{D as at}from"./download-bwqK3ulf.js";import{P as ut}from"./plus-C2o0386P.js";import{E as ns}from"./eye-off-Dv_sEjAY.js";import{C as cs}from"./calculator-CPUBN-yA.js";import{H as is}from"./history-D1YUGYyd.js";import{C as nt}from"./check-circle-8oGxTki5.js";import{I as ct}from"./info-D4lm7fBv.js";import{T as it}from"./trash-2-DCbqoVbR.js";import{P as os}from"./printer-BkLl9NNZ.js";import{X as ls}from"./x-circle-CN1zMonK.js";import"./chevron-down-BFYGIyCo.js";import"./shield-DYPDNaY8.js";import"./useCompanyInfo-kGS5xcZ6.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ds=lt("Gift",[["rect",{x:"3",y:"8",width:"18",height:"4",rx:"1",key:"bkv52"}],["path",{d:"M12 8v13",key:"1c76mn"}],["path",{d:"M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7",key:"6wjy6b"}],["path",{d:"M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5",key:"1ihvrl"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ot=lt("Smartphone",[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]]),us=({isOpen:B,onClose:u,orderData:l,onPaymentSuccess:y,onPaymentError:s})=>{var T;const[S,Y]=i.useState(""),[D,f]=i.useState(""),[$,k]=i.useState({number:"",expiryMonth:"",expiryYear:"",cvc:"",holderName:""}),[q,x]=i.useState(!1),[C,E]=i.useState({}),o=[{id:"cash",name:"Cash",icon:Rt,description:"Cash payment",color:"text-green-600",bgColor:"bg-green-50",borderColor:"border-green-200"},{id:"credit_card",name:"Credit Card",icon:Oe,description:"Visa, Mastercard, Amex",color:"text-blue-600",bgColor:"bg-blue-50",borderColor:"border-blue-200"},{id:"debit_card",name:"Debit Card",icon:Oe,description:"Visa, Mastercard debit",color:"text-purple-600",bgColor:"bg-purple-50",borderColor:"border-purple-200"},{id:"digital_wallet",name:"Digital Wallet",icon:ot,description:"Apple Pay, Google Pay",color:"text-orange-600",bgColor:"bg-orange-50",borderColor:"border-orange-200"},{id:"check",name:"Check",icon:Xt,description:"Check payment",color:"text-gray-600",bgColor:"bg-gray-50",borderColor:"border-gray-200"},{id:"gift_card",name:"Gift Card",icon:ds,description:"Store gift card",color:"text-pink-600",bgColor:"bg-pink-50",borderColor:"border-pink-200"},{id:"store_credit",name:"Store Credit",icon:Oe,description:"Store credit account",color:"text-indigo-600",bgColor:"bg-indigo-50",borderColor:"border-indigo-200"}];i.useEffect(()=>{l&&l.total&&f(l.total.toString())},[l]),i.useEffect(()=>{B||(Y(""),f(""),k({number:"",expiryMonth:"",expiryYear:"",cvc:"",holderName:""}),E({}))},[B]);const j=()=>{const m={};return S||(m.method="Please select a payment method"),(!D||parseFloat(D)<=0)&&(m.amount="Please enter a valid amount"),l&&parseFloat(D)>l.total&&(m.amount="Amount cannot exceed order total"),["credit_card","debit_card"].includes(S)&&((!$.number||$.number.length<13)&&(m.cardNumber="Please enter a valid card number"),(!$.expiryMonth||!$.expiryYear)&&(m.cardExpiry="Please enter card expiry date"),(!$.cvc||$.cvc.length<3)&&(m.cardCvc="Please enter a valid CVC"),$.holderName||(m.cardHolder="Please enter cardholder name")),E(m),Object.keys(m).length===0},N=async()=>{if(j()){x(!0),E({});try{const m={orderId:l._id,paymentMethod:S,amount:parseFloat(D),currency:"USD",gateway:["credit_card","debit_card","digital_wallet"].includes(S)?"stripe":"manual",cardDetails:["credit_card","debit_card"].includes(S)?$:void 0,metadata:{terminalId:"POS_001",location:"Main Store",ipAddress:"127.0.0.1",userAgent:navigator.userAgent}},_=await(await fetch("/api/payments/process",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(m)})).json();if(_.success)te("Payment processed successfully!"),y&&y(_.data),u();else throw new Error(_.message||"Payment processing failed")}catch(m){console.error("Payment error:",m),se(m,"Payment Processing"),s&&s(m)}finally{x(!1)}}},A=m=>{const g=m.replace(/\s+/g,"").replace(/[^0-9]/gi,""),_=g.match(/\d{4,16}/g),w=_&&_[0]||"",M=[];for(let v=0,z=w.length;v<z;v+=4)M.push(w.substring(v,v+4));return M.length?M.join(" "):g},H=m=>{const g=A(m.target.value);k(_=>({..._,number:g}))};return B?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Process Payment"}),e.jsx("button",{onClick:u,className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(Tt,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[l&&e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h3",{className:"font-medium text-gray-900 mb-2",children:"Order Summary"}),e.jsxs("div",{className:"text-sm text-gray-600 space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Order #:"}),e.jsx("span",{children:l.orderNumber||l._id})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Total Amount:"}),e.jsxs("span",{className:"font-medium",children:["$",(T=l.total)==null?void 0:T.toFixed(2)]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Select Payment Method"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:o.map(m=>{const g=m.icon;return e.jsx("button",{onClick:()=>Y(m.id),className:`p-4 rounded-lg border-2 transition-all ${S===m.id?`${m.borderColor} ${m.bgColor} ring-2 ring-offset-2 ring-current`:"border-gray-200 hover:border-gray-300"}`,children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(g,{className:`h-6 w-6 ${m.color}`}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:`font-medium ${m.color}`,children:m.name}),e.jsx("div",{className:"text-xs text-gray-500",children:m.description})]})]})},m.id)})}),C.method&&e.jsxs("p",{className:"mt-1 text-sm text-red-600 flex items-center",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),C.method]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Payment Amount"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"$"})}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:(l==null?void 0:l.total)||999999,value:D,onChange:m=>f(m.target.value),className:"block w-full pl-7 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"0.00"})]}),C.amount&&e.jsxs("p",{className:"mt-1 text-sm text-red-600 flex items-center",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),C.amount]})]}),["credit_card","debit_card"].includes(S)&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Card Details"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Card Number"}),e.jsx("input",{type:"text",value:$.number,onChange:H,className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"1234 5678 9012 3456",maxLength:"19"}),C.cardNumber&&e.jsxs("p",{className:"mt-1 text-sm text-red-600 flex items-center",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),C.cardNumber]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Expiry Date"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{type:"number",value:$.expiryMonth,onChange:m=>k(g=>({...g,expiryMonth:m.target.value})),className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"MM",min:"1",max:"12"}),e.jsx("input",{type:"number",value:$.expiryYear,onChange:m=>k(g=>({...g,expiryYear:m.target.value})),className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"YYYY",min:"2024"})]}),C.cardExpiry&&e.jsxs("p",{className:"mt-1 text-sm text-red-600 flex items-center",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),C.cardExpiry]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"CVC"}),e.jsx("input",{type:"text",value:$.cvc,onChange:m=>k(g=>({...g,cvc:m.target.value.replace(/\D/g,"")})),className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"123",maxLength:"4"}),C.cardCvc&&e.jsxs("p",{className:"mt-1 text-sm text-red-600 flex items-center",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),C.cardCvc]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cardholder Name"}),e.jsx("input",{type:"text",value:$.holderName,onChange:m=>k(g=>({...g,holderName:m.target.value})),className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm",placeholder:"John Doe"}),C.cardHolder&&e.jsxs("p",{className:"mt-1 text-sm text-red-600 flex items-center",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),C.cardHolder]})]})]}),S==="digital_wallet"&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ot,{className:"h-5 w-5 text-blue-600 mr-2"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium",children:"Digital Wallet Payment"}),e.jsx("p",{children:"This will open your digital wallet for payment processing."})]})]})})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-3 p-6 border-t bg-gray-50",children:[e.jsx("button",{onClick:u,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",disabled:q,children:"Cancel"}),e.jsx(Ae,{onClick:N,loading:q,className:"px-4 py-2 text-sm font-medium text-white bg-primary-600 border border-transparent rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500",children:q?"Processing...":"Process Payment"})]})]})}):null},ms=({src:B,webpSrc:u,alt:l="",className:y="",sizes:s=null,lazy:S=!0,fallback:Y=null,style:D={},...f})=>{const[$,k]=i.useState(!1),[q,x]=i.useState(!1),[C,E]=i.useState(!S),o=i.useRef(null);i.useEffect(()=>{if(!S||C)return;const g=new IntersectionObserver(_=>{_.forEach(w=>{w.isIntersecting&&(E(!0),g.disconnect())})},{rootMargin:"50px"});return o.current&&g.observe(o.current),()=>{o.current&&g.unobserve(o.current),g.disconnect()}},[S,C]);const j=()=>{if(!s||!u)return null;const g=[],_=u.replace(/\.webp$/,"");return s.thumbnail&&g.push(`${_}_thumbnail.webp 150w`),s.small&&g.push(`${_}_small.webp 300w`),s.medium&&g.push(`${_}_medium.webp 600w`),s.large&&g.push(`${_}_large.webp 1200w`),g.length>0?g.join(", "):null},N=()=>"(max-width: 640px) 300px, (max-width: 1024px) 600px, 1200px",A=()=>{k(!0)},H=()=>{x(!0)};if(S&&!C)return e.jsx("div",{ref:o,className:`bg-gray-200 animate-pulse ${y}`,style:{minHeight:"200px",...D},...f});if(q)return Y?e.jsx("img",{src:Y,alt:l,className:y,style:D,...f}):e.jsx("div",{className:`bg-gray-200 flex items-center justify-center ${y}`,style:{minHeight:"200px",...D},...f,children:e.jsx("span",{className:"text-gray-400 text-sm",children:"Image not available"})});const T=j(),m=T?N():void 0;return e.jsxs("picture",{ref:o,className:y,style:D,children:[u&&T&&e.jsx("source",{srcSet:T,sizes:m,type:"image/webp"}),u&&!T&&e.jsx("source",{srcSet:u,type:"image/webp"}),e.jsx("img",{src:B,alt:l,className:`${y} ${$?"opacity-100 transition-opacity duration-300":"opacity-0"}`,onLoad:A,onError:H,loading:S?"lazy":"eager",decoding:"async",...f})]})},xs=({recommendation:B,position:u,onAddToCart:l,onViewProduct:y,showReason:s=!0,showScore:S=!1,className:Y=""})=>{var m,g,_,w,M,v,z,re;const[D,f]=i.useState(!1),[$,k]=i.useState(!1),{isMobile:q}=He(),{product:x,score:C,reason:E}=B,o=async()=>{if(!$){k(!0);try{B._id&&await ve.trackInteraction(B._id,{productId:x._id,action:"add_to_cart",position:u}),l&&await l(x)}catch(J){se(J,"Add to Cart")}finally{k(!1)}}},j=async()=>{try{B._id&&await ve.trackInteraction(B._id,{productId:x._id,action:"click",position:u}),y&&y(x)}catch(J){se(J,"View Product")}},N=()=>{switch(E){case"trending":return e.jsx(qe,{className:"h-4 w-4 text-orange-500"});case"frequently_bought_together":return e.jsx(me,{className:"h-4 w-4 text-blue-500"});case"similar_products":return e.jsx(me,{className:"h-4 w-4 text-purple-500"});case"seasonal":return e.jsx(ts,{className:"h-4 w-4 text-yellow-500"});case"collaborative_filtering":return e.jsx(es,{className:"h-4 w-4 text-red-500"});case"content_similarity":return e.jsx(me,{className:"h-4 w-4 text-green-500"});case"price_range":return e.jsx(me,{className:"h-4 w-4 text-indigo-500"});default:return e.jsx(me,{className:"h-4 w-4 text-gray-500"})}},A=()=>{switch(E){case"trending":return"Trending Now";case"frequently_bought_together":return"Frequently Bought Together";case"similar_products":return"Similar Products";case"seasonal":return"Seasonal Pick";case"collaborative_filtering":return"Customers Also Bought";case"content_similarity":return"You Might Like";case"price_range":return"In Your Price Range";default:return"Recommended"}},H=((m=x.inventory)==null?void 0:m.currentStock)<=((g=x.inventory)==null?void 0:g.reorderPoint),T=((_=x.inventory)==null?void 0:_.currentStock)===0;return e.jsxs("div",{className:`bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 ${Y}`,onMouseEnter:()=>f(!0),onMouseLeave:()=>f(!1),children:[e.jsxs("div",{className:"relative aspect-square bg-gray-100 rounded-t-lg overflow-hidden",children:[x.image?e.jsx(ms,{src:x.image,webpSrc:x.imageWebp||((w=x.image)==null?void 0:w.replace(/\.(jpg|jpeg|png)$/i,".webp")),alt:x.name,className:"w-full h-full object-cover",sizes:{thumbnail:!0,small:!0,medium:!0,large:!0},lazy:!0}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx(me,{className:"h-12 w-12 text-gray-400"})}),(H||T)&&e.jsx("div",{className:"absolute top-2 right-2",children:T?e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800",children:[e.jsx(rt,{className:"h-3 w-3 mr-1"}),"Out of Stock"]}):e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800",children:[e.jsx(rt,{className:"h-3 w-3 mr-1"}),"Low Stock"]})}),s&&e.jsx("div",{className:"absolute top-2 left-2",children:e.jsxs("div",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-white bg-opacity-90 text-gray-700",children:[N(),e.jsx("span",{className:"ml-1 hidden sm:inline",children:A()})]})}),S&&e.jsx("div",{className:"absolute bottom-2 right-2",children:e.jsxs("div",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:[Math.round(C*100),"%"]})})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("h3",{className:"font-medium text-gray-900 text-sm line-clamp-2 mb-1",children:x.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Category: ",x.category||"N/A"]})]}),e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:"text-lg font-bold text-gray-900",children:["$",((v=(M=x.pricing)==null?void 0:M.retail)==null?void 0:v.toFixed(2))||"0.00"]}),((z=x.pricing)==null?void 0:z.wholesale)&&x.pricing.wholesale!==x.pricing.retail&&e.jsxs("span",{className:"text-sm text-gray-500 line-through",children:["$",x.pricing.wholesale.toFixed(2)]})]})}),e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-gray-500",children:"Stock:"}),e.jsx("span",{className:`font-medium ${T?"text-red-600":H?"text-yellow-600":"text-green-600"}`,children:((re=x.inventory)==null?void 0:re.currentStock)||0})]})}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{onClick:j,className:"flex-1 btn btn-secondary btn-sm flex items-center justify-center",children:[e.jsx(Ye,{className:"h-4 w-4 mr-1"}),q?"View":"View Details"]}),e.jsx("button",{onClick:o,disabled:T||$,className:"flex-1 btn btn-primary btn-sm flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed",children:$?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsxs(e.Fragment,{children:[e.jsx(Ve,{className:"h-4 w-4 mr-1"}),q?"Add":"Add to Cart"]})})]}),e.jsx("div",{className:"mt-2 flex justify-center",children:e.jsx("button",{onClick:async()=>{try{B._id&&await ve.trackInteraction(B._id,{productId:x._id,action:"dismiss",position:u})}catch(J){se(J,"Dismiss Recommendation")}},className:"text-xs text-gray-400 hover:text-gray-600 transition-colors",children:"Not interested"})})]})]})},ps=({title:B="Recommended for You",algorithm:u="hybrid",context:l={},limit:y=8,showTitle:s=!0,showControls:S=!0,onAddToCart:Y,onViewProduct:D,className:f=""})=>{var _,w,M;const[$]=i.useState(()=>`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),[k,q]=i.useState(u),[x,C]=i.useState(!1);He();const{data:E,isLoading:o,error:j,refetch:N}=It(["recommendations",{algorithm:k,context:l,limit:y}],()=>ve.generateRecommendations({sessionId:$,algorithm:k,context:l,limit:y}),{enabled:!0,staleTime:5*60*1e3,cacheTime:10*60*1e3,onError:v=>{se(v,"Recommendations")}}),A=async()=>{C(!0);try{await N(),te("Recommendations updated")}catch(v){se(v,"Refresh Recommendations")}finally{C(!1)}},H=v=>{q(v)},T=async v=>{try{Y&&await Y(v),te(`${v.name} added to cart`)}catch(z){se(z,"Add to Cart")}},m=v=>{D&&D(v)},g=[{value:"hybrid",label:"Smart Recommendations",icon:$e},{value:"trending",label:"Trending Now",icon:qe},{value:"frequently_bought",label:"Frequently Bought",icon:Ve},{value:"similar_products",label:"Similar Products",icon:Ye},{value:"collaborative",label:"Others Also Bought",icon:qe},{value:"seasonal",label:"Seasonal Picks",icon:$e}];return j?e.jsxs("div",{className:`text-center py-8 ${f}`,children:[e.jsx("div",{className:"text-red-500 mb-4",children:e.jsx(De,{className:"h-8 w-8 mx-auto"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Unable to load recommendations"}),e.jsx("p",{className:"text-gray-500 mb-4",children:j.message}),e.jsx("button",{onClick:()=>N(),className:"btn btn-primary",children:"Try Again"})]}):e.jsxs(Bt,{className:f,children:[s&&e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-primary-100 rounded-lg",children:e.jsx($e,{className:"h-6 w-6 text-primary-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:B}),e.jsx("p",{className:"text-sm text-gray-500",children:(_=g.find(v=>v.value===k))==null?void 0:_.label})]})]}),S&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("select",{value:k,onChange:v=>H(v.target.value),className:"select select-sm",children:g.map(v=>e.jsx("option",{value:v.value,children:v.label},v.value))}),e.jsx(Ae,{onClick:A,isLoading:x,className:"btn btn-secondary btn-sm",children:e.jsx(De,{className:"h-4 w-4"})})]})]}),o&&e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:Array.from({length:y}).map((v,z)=>e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"aspect-square bg-gray-200 rounded-lg mb-4"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-2/3 mb-2"}),e.jsx("div",{className:"h-6 bg-gray-200 rounded w-1/2 mb-4"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded flex-1"}),e.jsx("div",{className:"h-8 bg-gray-200 rounded flex-1"})]})]})},z))}),(E==null?void 0:E.recommendations)&&e.jsx(Ft,{cols:{default:2,md:3,lg:4},gap:4,className:"mb-6",children:E.recommendations.map((v,z)=>e.jsx(xs,{recommendation:{...v,_id:E.recommendationId},position:z+1,onAddToCart:T,onViewProduct:m,showReason:!0,showScore:!1},`${v.product._id}-${z}`))}),((w=E==null?void 0:E.recommendations)==null?void 0:w.length)===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-gray-400 mb-4",children:e.jsx($e,{className:"h-12 w-12 mx-auto"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No recommendations available"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"We need more data to provide personalized recommendations."}),e.jsxs("button",{onClick:A,className:"btn btn-primary",children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),"Refresh"]})]}),(E==null?void 0:E.metadata)&&e.jsx("div",{className:"mt-4 p-3 bg-gray-50 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[e.jsxs("span",{children:["Generated in ",E.metadata.processingTime,"ms"]}),e.jsxs("span",{children:[((M=E.recommendations)==null?void 0:M.length)||0," recommendations"]})]})})]})},hs=()=>`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,fs=()=>{let B=sessionStorage.getItem("recommendation_session_id");return B||(B=hs(),sessionStorage.setItem("recommendation_session_id",B)),B},gs=()=>{const B=i.useRef(fs()),u=i.useRef([]),l=i.useRef(!1),y=async o=>{const j={sessionId:B.current,...o,timestamp:new Date().toISOString()};u.current.push(j),l.current||s()},s=async()=>{if(!(l.current||u.current.length===0)){for(l.current=!0;u.current.length>0;){const o=u.current.shift();try{await ve.trackBehavior(o)}catch(j){console.error("Error tracking behavior:",j),(o.action==="purchase"||o.action==="add_to_cart")&&u.current.unshift(o)}}l.current=!1}},S=(o,j=null)=>{y({action:"page_view",entity:{type:"page",name:o},context:{page:o,referrer:j,userAgent:navigator.userAgent,timestamp:Date.now()}})},Y=(o,j=null)=>{var N;y({action:"product_view",entity:{type:"product",id:o._id,ref:"Product",name:o.name,category:o.category},metadata:{productPrice:(N=o.pricing)==null?void 0:N.retail,position:j}})},D=(o,j=null)=>{var N;y({action:"product_click",entity:{type:"product",id:o._id,ref:"Product",name:o.name,category:o.category},metadata:{productPrice:(N=o.pricing)==null?void 0:N.retail,position:j}})},f=(o,j=1,N=null)=>{var A,H;y({action:"add_to_cart",entity:{type:"product",id:o._id,ref:"Product",name:o.name,category:o.category},metadata:{productPrice:(A=o.pricing)==null?void 0:A.retail,quantity:j,position:N,cartValue:((H=o.pricing)==null?void 0:H.retail)*j}})},$=(o,j=1,N=null)=>{var A;y({action:"remove_from_cart",entity:{type:"product",id:o._id,ref:"Product",name:o.name,category:o.category},metadata:{productPrice:(A=o.pricing)==null?void 0:A.retail,quantity:j,position:N}})},k=(o,j,N=null)=>{o.forEach((A,H)=>{var T,m,g,_,w;y({action:"purchase",entity:{type:"product",id:A._id||((T=A.product)==null?void 0:T._id),ref:"Product",name:A.name||((m=A.product)==null?void 0:m.name),category:A.category||((g=A.product)==null?void 0:g.category)},metadata:{productPrice:A.price||((w=(_=A.product)==null?void 0:_.pricing)==null?void 0:w.retail),quantity:A.quantity,position:H+1,totalAmount:j,orderId:N}})})},q=(o,j=0,N={})=>{y({action:"search",entity:{type:"search",name:o},metadata:{searchQuery:o,resultsCount:j,filterCriteria:N}})},x=(o,j=null)=>{y({action:"category_view",entity:{type:"category",id:o._id,ref:"Category",name:o.name},metadata:{position:j}})},C=(o,j,N=0)=>{y({action:"filter",entity:{type:"filter",name:o},metadata:{filterType:o,filterValue:j,resultsCount:N}})},E=(o,j,N,A=null)=>{y({action:`recommendation_${N}`,entity:{type:"product",id:j,ref:"Product"},metadata:{recommendationId:o,position:A,interactionType:N}})};return i.useEffect(()=>()=>{u.current.length>0&&s()},[]),{sessionId:B.current,trackBehavior:y,trackPageView:S,trackProductView:Y,trackProductClick:D,trackAddToCart:f,trackRemoveFromCart:$,trackPurchase:k,trackSearch:q,trackCategoryView:x,trackFilter:C,trackRecommendationInteraction:E}},bs=({onAddProduct:B,selectedCustomer:u,showCostPrice:l,onLastPurchasePriceFetched:y,hasCostPricePermission:s,priceType:S})=>{const[Y,D]=i.useState(""),[f,$]=i.useState(null),[k,q]=i.useState(1),[x,C]=i.useState(""),[E,o]=i.useState(0),[j,N]=i.useState(!1),[A,H]=i.useState(0),[T,m]=i.useState(null),[g,_]=i.useState(!1),w=i.useRef(null),{data:M,isLoading:v,error:z}=Wt({limit:100,status:"active"},{keepPreviousData:!0,staleTime:3e4}),re=Gt.useMemo(()=>{var d,R,F;return M?Array.isArray(M)?M:(d=M==null?void 0:M.data)!=null&&d.products?M.data.products:M!=null&&M.products?M.products:(F=(R=M==null?void 0:M.data)==null?void 0:R.data)!=null&&F.products?M.data.data.products:[]:[]},[M]),J=zt(re,Y,["name","description","brand"],{threshold:.4,minScore:.3,limit:10}),ae=(d,R)=>d?R==="wholesale"?d.pricing.wholesale||d.pricing.retail:R==="retail"?d.pricing.retail:d.pricing.wholesale||d.pricing.retail:0,xe=async d=>{if($(d),q(1),N(!0),D(d.name),d._id)try{const F=await Ue.getLastPurchasePrice(d._id);F.data&&F.data.lastPurchasePrice!==null?(m(F.data.lastPurchasePrice),y&&y(d._id,F.data.lastPurchasePrice)):m(null)}catch(F){console.error("Error fetching last purchase price:",F),m(null)}else m(null);const R=ae(d,S);o(R),C(R.toString())};i.useEffect(()=>{if(f){const d=ae(f,S);o(d);const R=ae(f,S==="wholesale"?"retail":"wholesale");(!x||x===R.toString()||x===E.toString())&&C(d.toString())}},[S,f]);const ne=async()=>{if(f){if(!x||parseInt(x)<=0){X.error("Please enter a valid rate");return}if(f.inventory.currentStock===0){X.error(`${f.name} is out of stock and cannot be added to the invoice.`);return}if(k>f.inventory.currentStock){X.error(`Cannot add ${k} units. Only ${f.inventory.currentStock} units available in stock.`);return}try{const d=parseInt(x)||Math.round(E);if(T!==null&&d<T){const F=T-d,Z=(F/T*100).toFixed(1);if(!window.confirm(`⚠️ WARNING: Sale price ($${d}) is below cost price ($${Math.round(T)}).

Loss per unit: $${Math.round(F)} (${Z}%)
Total loss for ${k} unit(s): $${Math.round(F*k)}

Do you want to proceed?`))return;X.warning(`Product added with loss: $${Math.round(F)} per unit (${Z}%)`,{duration:6e3})}B({product:f,quantity:k,unitPrice:d}),$(null),q(1),C(""),o(0),N(!1),D(""),H(F=>F+1),setTimeout(()=>{w.current&&w.current.focus()},100);const R=(u==null?void 0:u.businessType)==="wholesale"?"wholesale":(u==null?void 0:u.businessType)==="distributor"?"distributor":"retail";X.success(`${f.name} added to cart at ${R} price: ${Math.round(d)}`)}catch(d){se(d,"Product Price Check")}}},pe=d=>{d.key==="Enter"&&j?(d.preventDefault(),ne()):d.key==="Escape"&&j&&(d.preventDefault(),$(null),q(1),C(""),o(0),N(!1))},Me=d=>{var Z;d.inventory.currentStock<=d.inventory.reorderPoint,d.inventory.currentStock;let R=d.pricing.wholesale||d.pricing.retail;S==="wholesale"?R=d.pricing.wholesale||d.pricing.retail:S==="retail"&&(R=d.pricing.retail);const F=((Z=d.pricing)==null?void 0:Z.cost)||0;return e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("div",{className:"font-medium",children:d.name}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Stock: ",d.inventory.currentStock]}),l&&s&&e.jsxs("div",{className:"text-sm text-red-600 font-medium",children:["Cost: $",Math.round(F)]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Price: $",Math.round(R)]})]})]})},he=l&&s?"col-span-6":"col-span-7";return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{children:e.jsxs("div",{className:"grid grid-cols-12 gap-4 items-end",children:[e.jsxs("div",{className:he,children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Product Search"}),e.jsxs("div",{className:"relative flex space-x-2",children:[e.jsx("div",{className:"flex-1",children:e.jsx(dt,{ref:w,placeholder:"Search or select product...",items:J||[],onSelect:xe,onSearch:D,displayKey:Me,selectedItem:f,loading:v,emptyMessage:Y.length>0?"No products found":"Start typing to search products...",value:Y},A)}),e.jsx("button",{type:"button",onClick:()=>_(!0),className:"px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors flex items-center justify-center",title:"Scan barcode to search product",children:e.jsx(rs,{className:"h-5 w-5 text-gray-600"})})]})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stock"}),e.jsx("span",{className:"text-sm font-semibold text-gray-700 bg-gray-100 px-2 py-1 rounded border border-gray-200 block text-center h-10 flex items-center justify-center",children:f?f.inventory.currentStock:"0"})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Quantity"}),e.jsx("input",{type:"number",min:"1",max:f==null?void 0:f.inventory.currentStock,value:k,onChange:d=>q(parseInt(d.target.value)||1),onKeyDown:pe,onFocus:d=>d.target.select(),className:"input text-center",placeholder:"1 (Enter to add & focus search)",autoFocus:j})]}),l&&s&&e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Cost"}),e.jsx("span",{className:"text-sm font-semibold text-red-700 bg-red-50 px-2 py-1 rounded border border-red-200 block text-center h-10 flex items-center justify-center",title:"Last Purchase Price",children:T!==null?`$${Math.round(T)}`:f?"N/A":"$0"})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Rate"}),e.jsx("input",{type:"number",step:"1",value:x,onChange:d=>C(d.target.value),onKeyDown:pe,onFocus:d=>d.target.select(),className:"input text-center",placeholder:"0 (Enter to add & focus search)",required:!0})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Amount"}),e.jsx("span",{className:"text-sm font-semibold text-gray-700 bg-gray-100 px-2 py-1 rounded border border-gray-200 block text-center h-10 flex items-center justify-center",children:j?Math.round(k*parseInt(x||0)):0})]}),e.jsx("div",{className:"col-span-1 flex items-end",children:e.jsxs("button",{type:"button",onClick:ne,className:"w-full btn btn-primary flex items-center justify-center px-3 py-2",disabled:!f,title:"Add to cart (or press Enter in Quantity/Rate fields - focus returns to search)",children:[e.jsx(ut,{className:"h-4 w-4 mr-2"}),"Add"]})})]})}),e.jsx(as,{isOpen:g,onClose:()=>_(!1),onScan:d=>{const R=re.find(F=>F.barcode===d||F.sku===d);R?(xe(R),X.success(`Product found: ${R.name}`)):(D(d),X.info(`Searching for: ${d}`)),_(!1)},scanMode:"both"})]})},Ks=({tabId:B,editData:u})=>{var tt,st;const[l,y]=i.useState([]),[s,S]=i.useState(null),[Y,D]=i.useState(""),[f,$]=i.useState("cash"),[k,q]=i.useState(""),[x,C]=i.useState(0),[E,o]=i.useState(!1),[j,N]=i.useState(!1),[A,H]=i.useState(null),[T,m]=i.useState([]),[g,_]=i.useState(!0),[w,M]=i.useState({type:"amount",value:0}),[v,z]=i.useState(!1),[re,J]=i.useState(""),[ae,xe]=i.useState(!0),[ne,pe]=i.useState(""),[Me,he]=i.useState(!1),[d,R]=i.useState({}),[F,Z]=i.useState(!1),[G,oe]=i.useState({}),[de,mt]=i.useState(!1),[K,Ee]=i.useState({}),[Le,Ge]=i.useState("wholesale"),[xt,Ne]=i.useState(!1),[Q,we]=i.useState("pdf"),[Te,We]=i.useState(!1),ce=(()=>{const t=new Date,r=new Date;r.setMonth(t.getMonth()-1);const c=n=>{const a=n.getFullYear(),p=String(n.getMonth()+1).padStart(2,"0"),P=String(n.getDate()).padStart(2,"0");return`${a}-${p}-${P}`};return{from:c(r),to:c(t)}})(),[fe,Pe]=i.useState(ce.from),[Se,ke]=i.useState(ce.to),{isMobile:ge}=He(),{trackProductView:pt}=gs(),{updateTabTitle:ze,getActiveTab:Je,openTab:ht}=Ot(),{hasPermission:Re,user:Ie}=Dt(),[Ke,ft]=i.useState(!1),Qe=i.useMemo(()=>!Array.isArray(l)||l.length===0?0:l.reduce((t,r)=>{var h,V,O;if(!(r!=null&&r.product))return t;const c=r.product._id,n=Number(r.quantity)||0,a=Number(r.unitPrice)||0,P=(c&&K[c]!==void 0?Number(K[c]):null)??Number((h=r.product.pricing)==null?void 0:h.cost)??Number((V=r.product.pricing)==null?void 0:V.purchasePrice)??Number((O=r.product.pricing)==null?void 0:O.wholesaleCost)??0,U=(a-(Number.isFinite(P)?P:0))*n;return t+(Number.isFinite(U)?U:0)},0),[l,K]),Be=t=>{if(!t)return"";const r=new Date,c=r.getFullYear(),n=String(r.getMonth()+1).padStart(2,"0"),a=String(r.getDate()).padStart(2,"0"),p=String(r.getTime()).slice(-4);return`INV-${t.displayName.split(" ").map(b=>b.charAt(0).toUpperCase()).join("").substring(0,3)}-${c}${n}${a}-${p}`};i.useEffect(()=>{if(u&&u.isEditMode&&u.orderId){if(u.customer&&S(u.customer),u.orderNumber&&(J(u.orderNumber),xe(!1)),u.notes&&pe(u.notes),u.items&&u.items.length>0){const t=u.items.map(r=>{var c,n,a,p;return{product:r.product,quantity:r.quantity,unitPrice:r.unitPrice||r.price||((n=(c=r.product)==null?void 0:c.pricing)==null?void 0:n.retail)||0,totalPrice:r.totalPrice||r.quantity*(r.unitPrice||r.price||((p=(a=r.product)==null?void 0:a.pricing)==null?void 0:p.retail)||0)}});y(t)}u.isTaxExempt!==void 0&&_(u.isTaxExempt),u.payment&&($(u.payment.method||"cash"),C(u.payment.amount||0),u.payment.method==="bank"?q(u.payment.bankAccount||""):q("")),u.orderType}},[u==null?void 0:u.orderId]);const be=i.useMemo(()=>(banksData||[]).filter(t=>t.isActive!==!1),[banksData]);i.useEffect(()=>{if(f==="bank"&&!k){const t=be.find(r=>r==null?void 0:r.isDefault)||be[0];t!=null&&t._id&&q(t._id)}},[f,k,be]),i.useEffect(()=>{var t;if(s&&((t=customers==null?void 0:customers.data)!=null&&t.customers)){const r=customers.data.customers.find(c=>c._id===s._id);r&&(r.pendingBalance!==s.pendingBalance||r.advanceBalance!==s.advanceBalance||r.currentBalance!==s.currentBalance)&&S(r)}},[(tt=customers==null?void 0:customers.data)==null?void 0:tt.customers]);const ue=l.reduce((t,r)=>t+r.unitPrice*r.quantity,0),gt=T.reduce((t,r)=>t+r.amount,0);let Ce=0;w.value>0&&(w.type==="percentage"?Ce=ue*w.value/100:Ce=Math.min(w.value,ue));const ye=gt+Ce,Xe=ue-ye,_e=g?0:Xe*.08,ee=Xe+_e,Fe=t=>t?t==="retail"||t==="wholesale"?t:t==="distributor"?"wholesale":"retail":"retail",bt=async t=>{S(t),R({}),Z(!1),oe({}),ae&&t&&J(Be(t));const r=Je();r&&t&&ze(r.id,`Sales - ${t.displayName}`)};i.useEffect(()=>{},[Le]),i.useEffect(()=>{(async()=>{if(l.length===0)return;const r=l.map(c=>c.product._id);if(r.length!==0)try{const c=await Ue.getLastPurchasePrices(r);if(c.data&&c.data.prices){const n={};Object.keys(c.data.prices).forEach(a=>{n[a]=c.data.prices[a].lastPurchasePrice}),Ee(a=>({...a,...n}))}}catch(c){console.error("Error fetching last purchase prices:",c)}})()},[l]);const Ze=async t=>{y(r=>{var n;const c=r.find(a=>a.product._id===t.product._id);if(c){const a=c.quantity+t.quantity,p=((n=t.product.inventory)==null?void 0:n.currentStock)||0;return a>p?(X.error(`Cannot add ${t.quantity} more units. Only ${p-c.quantity} additional units available (${c.quantity} already in cart).`),r):r.map(b=>b.product._id===t.product._id?{...b,quantity:b.quantity+t.quantity,unitPrice:t.unitPrice}:b)}return t.product._id&&Ue.getLastPurchasePrice(t.product._id).then(a=>{a.data&&a.data.lastPurchasePrice!==null&&Ee(p=>({...p,[t.product._id]:a.data.lastPurchasePrice}))}).catch(a=>console.error("Error fetching last purchase price:",a)),[...r,t]})},yt=async(t,r)=>{if(r<=0){et(t);return}y(c=>{var p;const n=c.find(P=>P.product._id===t);if(!n)return c;const a=((p=n.product.inventory)==null?void 0:p.currentStock)||0;return r>a?(X.error(`Cannot set quantity to ${r}. Only ${a} units available in stock.`),c):c.map(P=>P.product._id===t?{...P,quantity:r}:P)})},jt=(t,r)=>{if(r<0)return;if(l.find(n=>n.product._id===t)){const n=K[t];if(n!==void 0&&r<n){const a=n-r,p=(a/n*100).toFixed(1);X.error(`Warning: Sale price ($${r}) is below cost price ($${Math.round(n)}). Loss: $${Math.round(a)} (${p}%)`,{duration:5e3,position:"top-center",icon:"⚠️"})}}y(n=>n.map(a=>a.product._id===t?{...a,unitPrice:r}:a))},et=t=>{y(r=>{const c=r.filter(n=>n.product._id!==t);return c.length===0?(R({}),Z(!1),oe({})):(R(n=>{const a={...n};return delete a[t.toString()],Object.keys(a).length===0&&(Z(!1),oe({})),a}),oe(n=>{const a={...n};return delete a[t.toString()],a})),c})},vt=()=>{y(t=>{if(!t||t.length<2)return t;const r=n=>{const a=n.product;return a?typeof a=="string"?a:a.name||a.title||a.displayName||a.businessName||a.fullName||"":""};return[...t].sort((n,a)=>{const p=r(n).toString().toLowerCase(),P=r(a).toString().toLowerCase();return p<P?-1:p>P?1:0})})},Nt=async()=>{if(!s){I("Please select a customer first");return}if(l.length===0){I("Please add products to cart first");return}he(!0);try{const t=await salesAPI.getLastPrices(s._id),{prices:r,orderNumber:c,orderDate:n}=t.data;if(!r||Object.keys(r).length===0){I("No previous order found for this customer"),he(!1);return}const a={},p={};l.forEach(O=>{const L=O.product._id.toString();a[L]=O.unitPrice}),R(a);let P=0,b=0,U=0;const h=l.map(O=>{const L=O.product._id.toString();if(r[L]){const W=r[L].unitPrice,le=O.unitPrice;return W!==le?(P++,p[L]="updated",{...O,unitPrice:W}):(b++,p[L]="unchanged",O)}else return U++,p[L]="not-found",O});y(h),oe(p),Z(!0);const V=n?new Date(n).toLocaleDateString():"previous order";if(P>0){let O=`Applied prices from ${c||"previous order"} (${V}). Updated ${P} product(s).`;b>0&&(O+=` ${b} product(s) had same price.`),U>0&&(O+=` ${U} product(s) not found in previous order.`),te(O)}else b>0?te(`All products already have the same prices as in ${c||"previous order"} (${V}).`):I("No matching products found in previous order")}catch(t){se(t,"Apply Last Prices")}finally{he(!1)}},wt=()=>{if(Object.keys(d).length===0){I("No original prices to restore");return}let t=0;const r=l.map(c=>{const n=c.product._id.toString();return d[n]!==void 0?(t++,{...c,unitPrice:d[n]}):c});y(r),Z(!1),R({}),oe({}),t>0?te(`Restored original prices for ${t} product(s).`):I("No matching products found to restore")},{confirmation:Pt,confirmClear:St,handleConfirm:kt,handleCancel:Ct}=Qt(),_t=()=>{l.length>0&&St(l.length,"items",async()=>{y([]),S(null),D(""),m([]),_(!0),M({type:"amount",value:0}),z(!1),J(""),$("cash"),q(""),C(0),R({}),Z(!1),oe({}),Ge("wholesale");const t=Je();t&&ze(t.id,"Sales"),X.success("Cart cleared")})},$t=()=>{Ne(!0)},At=async()=>{var t,r,c,n;We(!0);try{const a={...(s==null?void 0:s._id)&&{customer:s._id},...fe&&{dateFrom:fe},...Se&&{dateTo:Se}};let p;if(Q==="excel"?p=await salesAPI.exportExcel(a):Q==="csv"?p=await salesAPI.exportCSV(a):Q==="json"?p=await salesAPI.exportJSON(a):Q==="pdf"&&(p=await salesAPI.exportPDF(a)),(t=p==null?void 0:p.data)!=null&&t.filename){const P=p.data.filename;try{Q==="pdf"&&await new Promise(h=>setTimeout(h,500));let b;try{b=await salesAPI.downloadFile(P)}catch(h){if(h.response){const V=h.response.data;if(V instanceof Blob){const O=new FileReader;O.onload=()=>{const L=O.result;try{const W=JSON.parse(L);I(W.message||`Download failed: ${h.response.status}`)}catch{I(`Download failed: ${h.response.status}`)}},O.readAsText(V)}else typeof V=="object"&&V!==null?I(V.message||`Download failed: ${h.response.status}`):I(`Download failed: ${h.response.status}`)}else I("Download failed: "+(h.message||"Network error"));return}if(!b){I("Download failed: No response received");return}if(b.status!==200){I(`Download failed with status ${b.status}`);return}if(!b.data){I("Download failed: No data received from server");return}const U=((r=b.headers)==null?void 0:r["content-type"])||((c=b.headers)==null?void 0:c["Content-Type"])||"";if(Q==="pdf"){const h=b.data;if(!h||!(h instanceof Blob)){if(typeof h=="string")I(`Server error: ${h.substring(0,100)}`);else if(h&&typeof h=="object"){let L=h.message||h.error;if(!L)try{const W=JSON.stringify(h);W==="{}"||W==="null"||W===""?(L=h.statusText||h.status||"Unknown server error",console.error("Download response error - empty object:",{blob:h,contentType:U,responseStatus:b==null?void 0:b.status,responseHeaders:b==null?void 0:b.headers})):L=W.substring(0,150)}catch{L="Invalid response format"}I(`Server error: ${L||"Unknown error"}`)}else I("Invalid PDF file received - expected Blob. Response type: "+typeof h);return}if(U.includes("application/json")||U.includes("text/html")){const L=new FileReader;L.onload=()=>{const W=L.result;try{const le=JSON.parse(W);I(le.message||"File not found or generation failed")}catch{I("Server returned error instead of PDF. Please try again.")}},L.readAsText(h);return}if(h.size===0){I("PDF file is empty");return}if(h.type&&!h.type.includes("pdf")&&!h.type.includes("application/octet-stream")){const L=new FileReader;L.onload=()=>{const W=L.result;if(W.includes("<!DOCTYPE")||W.includes('{"error"')||W.includes('{"message"'))I("Server returned an error instead of PDF file");else{const le=URL.createObjectURL(h);if(window.open(le,"_blank"))te("PDF opened in new tab");else{const je=document.createElement("a");je.href=le,je.download=P,document.body.appendChild(je),je.click(),document.body.removeChild(je),te("PDF downloaded (popup was blocked)")}setTimeout(()=>URL.revokeObjectURL(le),1e4)}},L.readAsText(h.slice(0,100));return}const V=URL.createObjectURL(h);if(window.open(V,"_blank"))te("PDF opened in new tab");else{const L=document.createElement("a");L.href=V,L.download=P,document.body.appendChild(L),L.click(),document.body.removeChild(L),te("PDF downloaded (popup was blocked)")}setTimeout(()=>URL.revokeObjectURL(V),1e4)}else{const h=new Blob([b.data],{type:Q==="excel"?"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":Q==="csv"?"text/csv":"application/json"}),V=URL.createObjectURL(h),O=document.createElement("a");O.href=V,O.download=P,document.body.appendChild(O),O.click(),document.body.removeChild(O),URL.revokeObjectURL(V),te(`${Q.toUpperCase()} file downloaded successfully`)}}catch(b){if(b.response)if(b.response.data instanceof Blob){const U=new FileReader;U.onload=()=>{const h=U.result;try{const V=JSON.parse(h);I(V.message||"Download failed")}catch{I("Download failed: "+h.substring(0,100))}},U.readAsText(b.response.data)}else I(((n=b.response.data)==null?void 0:n.message)||`Download failed: ${b.response.status}`);else I("Download failed: "+(b.message||"Unknown error"));return}}Ne(!1)}catch(a){se(a,"Export")}finally{We(!1)}},Mt=()=>{if(l.length===0){I({message:"Cart is empty"});return}if(s&&s.creditLimit>0){const r=f||"cash",n=ee-(x||0);if(r==="account"||n>0){const a=s.currentBalance||0,p=s.pendingBalance||0,P=a+p,b=P+n,U=s.creditLimit-P;if(b>s.creditLimit){const h=`Credit limit exceeded for ${s.displayName||s.name}. Current balance: $${P.toFixed(2)}, Unpaid amount: $${n.toFixed(2)}, Credit limit: $${s.creditLimit.toFixed(2)}, Available credit: $${U.toFixed(2)}. Please collect payment or reduce the order amount.`;X.error(h,{duration:8e3,position:"top-center"});return}else if(U-n<s.creditLimit*.1){const h=`Warning: ${s.displayName||s.name} is near credit limit. Available credit: $${U.toFixed(2)}, After this order: $${(U-n).toFixed(2)} remaining.`;X.warning(h,{duration:6e3,position:"top-center"})}}}if(f==="bank"&&!k){I({message:"Please select a bank account for bank payments"});return}const t={orderType:Fe(s==null?void 0:s.businessType),customer:s==null?void 0:s._id,items:l.map(r=>({product:r.product._id,quantity:r.quantity,unitPrice:r.unitPrice})),appliedDiscounts:T,directDiscount:w,subtotal:ue,discountAmount:ye,tax:_e,isTaxExempt:g,total:ee,invoiceNumber:re,notes:(ne==null?void 0:ne.trim())||"",payment:{method:f,bankAccount:f==="bank"?k:null,amount:x,remainingBalance:ee-x,isPartialPayment:x<ee,isAdvancePayment:v,advanceAmount:v?x-ee:0}};if(u!=null&&u.isEditMode){const r=u.orderId,c={orderType:Fe(s==null?void 0:s.businessType),customer:s==null?void 0:s._id,items:l.map(n=>{const a=n.quantity*n.unitPrice,p=0,P=0,b=a-p+P;return{product:n.product._id,quantity:n.quantity,unitPrice:n.unitPrice,discountPercent:0,taxRate:0,subtotal:a,discountAmount:p,taxAmount:P,total:b}}),notes:ne||""};handleUpdateOrder(r,c)}else handleCreateOrder(t)},Et=async t=>{},Lt=t=>{console.error("Payment error:",t),o(!1),H(null)};return e.jsxs(Jt,{children:[e.jsxs("div",{className:"space-y-4 lg:space-y-6",children:[e.jsxs("div",{className:`flex ${ge?"flex-col space-y-4":"items-start justify-between"}`,children:[e.jsxs("div",{children:[e.jsx("h1",{className:`${ge?"text-xl":"text-2xl"} font-bold text-gray-900`,children:"Point of Sale"}),e.jsx("p",{className:"text-gray-600",children:"Process sales transactions"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("button",{onClick:$t,className:"btn btn-secondary btn-md",title:"Export Sales Report",children:[e.jsx(at,{className:"h-4 w-4 mr-2"}),"Export Sales Report"]}),e.jsxs("button",{onClick:()=>{const t=ss("/sales");if(t){const r=`tab_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;ht({title:"Sales",path:"/sales",component:t.component,icon:t.icon,allowMultiple:!0,props:{tabId:r}})}},className:"btn btn-primary btn-md",children:[e.jsx(ut,{className:"h-4 w-4 mr-2"}),"New Sales"]})]})]}),e.jsxs("div",{className:`flex ${ge?"flex-col space-y-4":"items-start space-x-4"}`,children:[e.jsxs("div",{className:`${ge?"w-full":"w-[500px] flex-shrink-0"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Select Customer"}),s&&e.jsx("button",{onClick:()=>{S(null),D("")},className:"text-xs text-blue-600 hover:text-blue-800 underline",title:"Change customer",children:"Change Customer"})]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("label",{className:"text-xs font-normal text-gray-400",children:"Price Type:"}),e.jsxs("select",{value:Le,onChange:t=>Ge(t.target.value),className:"border border-gray-200 rounded-md px-2 py-1 text-xs text-gray-600 focus:outline-none focus:ring-1 focus:ring-primary-400 focus:border-primary-400",children:[e.jsx("option",{value:"wholesale",children:"Wholesale"}),e.jsx("option",{value:"retail",children:"Retail"}),e.jsx("option",{value:"custom",children:"Custom"})]})]})})]}),e.jsx(dt,{placeholder:"Search customers by name, email, or business...",items:((st=customers==null?void 0:customers.data)==null?void 0:st.customers)||[],onSelect:bt,onSearch:D,selectedItem:s,displayKey:t=>{const r=t.pendingBalance||0,c=t.advanceBalance||0,n=r-c,a=n<0,p=r>0||c>0;return e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.displayName}),p?e.jsxs("div",{className:`text-sm ${a?"text-red-600":"text-green-600"}`,children:[a?"Advance:":"Receivables:"," $",Math.abs(n).toFixed(2)]}):null]})},loading:customersLoading,emptyMessage:"No customers found"})]}),e.jsx("div",{className:`${ge?"w-full":"flex-1"}`,children:s?e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(qt,{className:"h-5 w-5 text-gray-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:s.displayName}),e.jsxs("p",{className:"text-sm text-gray-600 capitalize",children:[s.businessType," • ",s.phone||"No phone"]}),e.jsxs("div",{className:"flex items-center space-x-4 mt-2",children:[(()=>{const t=s.pendingBalance||0,r=s.advanceBalance||0,c=t-r,n=c<0,a=c>0;return t>0||r>0?e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:"text-xs text-gray-500",children:n?"Advance:":"Receivables:"}),e.jsxs("span",{className:`text-sm font-medium ${n?"text-red-600":a?"text-green-600":"text-gray-600"}`,children:["$",Math.abs(c).toFixed(2)]})]}):null})(),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Credit Limit:"}),e.jsxs("span",{className:`text-sm font-medium ${s.creditLimit>0?(s.currentBalance||0)+(s.pendingBalance||0)>=s.creditLimit*.9?"text-red-600":(s.currentBalance||0)+(s.pendingBalance||0)>=s.creditLimit*.7?"text-yellow-600":"text-blue-600":"text-gray-600"}`,children:["$",(s.creditLimit||0).toFixed(2)]}),s.creditLimit>0&&(s.currentBalance||0)+(s.pendingBalance||0)>=s.creditLimit*.9&&e.jsx("span",{className:"text-xs text-red-600 font-bold ml-1",children:"⚠️"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Available Credit:"}),e.jsxs("span",{className:`text-sm font-medium ${s.creditLimit>0?s.creditLimit-((s.currentBalance||0)+(s.pendingBalance||0))<=s.creditLimit*.1?"text-red-600":s.creditLimit-((s.currentBalance||0)+(s.pendingBalance||0))<=s.creditLimit*.3?"text-yellow-600":"text-green-600":"text-gray-600"}`,children:["$",(s.creditLimit-((s.currentBalance||0)+(s.pendingBalance||0))).toFixed(2)]})]})]})]})]})}):e.jsx("div",{className:"hidden lg:block"})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Product Selection & Cart"}),e.jsxs("div",{className:"flex flex-wrap items-center justify-start lg:justify-end gap-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>mt(!de),className:"btn btn-secondary btn-sm flex items-center space-x-2",title:de?"Hide purchase cost prices":"Show purchase cost prices",children:de?e.jsxs(e.Fragment,{children:[e.jsx(ns,{className:"h-4 w-4"}),e.jsx("span",{children:"Hide Cost"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:"h-4 w-4"}),e.jsx("span",{children:"Show Cost"})]})}),(Ie==null?void 0:Ie.role)==="admin"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>ft(t=>!t),className:"btn btn-secondary btn-sm flex items-center space-x-2",title:"Show estimated profit (BP)",children:[e.jsx(cs,{className:"h-4 w-4"}),e.jsx("span",{children:Ke?"Hide BP":"Show BP"})]}),Ke&&e.jsx("span",{className:`text-sm font-semibold ${Qe>=0?"text-green-600":"text-red-600"}`,children:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(Qe||0)})]})]}),s&&l.length>0&&e.jsx(e.Fragment,{children:F?e.jsxs("button",{onClick:wt,className:"btn btn-secondary btn-sm flex items-center space-x-2",title:"Restore original/current prices",children:[e.jsx(Ut,{className:"h-4 w-4"}),e.jsx("span",{children:"Restore Current Prices"})]}):e.jsxs(Ae,{onClick:Nt,isLoading:Me,className:"btn btn-secondary btn-sm",title:"Apply prices from last order for this customer",children:[e.jsx(is,{className:"h-4 w-4 mr-2"}),"Apply Last Prices"]})})]})]})}),e.jsxs("div",{className:"card-content",children:[e.jsx("div",{className:"mb-6",children:e.jsx(bs,{onAddProduct:Ze,selectedCustomer:s,showCostPrice:de,hasCostPricePermission:Re("view_cost_prices"),priceType:Le,onLastPurchasePriceFetched:(t,r)=>{Ee(c=>({...c,[t]:r}))}})}),l.length===0?e.jsxs("div",{className:"p-8 text-center text-gray-500 border-t border-gray-200",children:[e.jsx(Ve,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("p",{className:"mt-2",children:"No items in cart"})]}):e.jsxs("div",{className:"space-y-4 border-t border-gray-200 pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h4",{className:"text-md font-medium text-gray-700",children:"Cart Items"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("button",{type:"button",onClick:vt,className:"btn btn-secondary btn-sm flex items-center space-x-2",title:"Sort products alphabetically",children:[e.jsx(Ht,{className:"h-4 w-4"}),e.jsx("span",{children:"Sort A-Z"})]}),F&&Object.keys(G).length>0&&e.jsxs("div",{className:"flex items-center space-x-3 text-xs",children:[e.jsx("span",{className:"text-gray-600 font-medium",children:"Price Status:"}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(nt,{className:"h-3 w-3 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"Updated"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ct,{className:"h-3 w-3 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"Same Price"})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(ie,{className:"h-3 w-3 text-yellow-600"}),e.jsx("span",{className:"text-gray-600",children:"Not in Last Order"})]})]})]})]}),l.map((t,r)=>{var a,p,P,b,U;const c=t.unitPrice*t.quantity,n=((a=t.product.inventory)==null?void 0:a.currentStock)<=((p=t.product.inventory)==null?void 0:p.reorderPoint);return e.jsx("div",{className:`py-1 ${r%2===0?"bg-white":"bg-gray-50"}`,children:e.jsxs("div",{className:"grid grid-cols-12 gap-4 items-center",children:[e.jsx("div",{className:"col-span-1",children:e.jsx("span",{className:"text-sm font-medium text-gray-700 bg-gray-50 px-0.5 py-1 rounded border border-gray-200 block text-center h-8 flex items-center justify-center",children:r+1})}),e.jsx("div",{className:`${de&&Re("view_cost_prices")?"col-span-5":"col-span-6"} flex items-center h-8`,children:e.jsxs("span",{className:"font-medium text-sm truncate",children:[t.product.name,n&&e.jsx("span",{className:"text-yellow-600 text-xs ml-2",children:"⚠️ Low Stock"}),K[t.product._id]!==void 0&&t.unitPrice<K[t.product._id]&&e.jsx("span",{className:"text-xs ml-2 px-1.5 py-0.5 rounded bg-red-100 text-red-700 font-bold",title:`Sale price below cost! Loss: $${Math.round(K[t.product._id]-t.unitPrice)} per unit`,children:"⚠️ Loss"}),F&&G[t.product._id]&&e.jsx("span",{className:`text-xs ml-2 px-1.5 py-0.5 rounded ${G[t.product._id]==="updated"?"bg-green-100 text-green-700":G[t.product._id]==="unchanged"?"bg-blue-100 text-blue-700":"bg-yellow-100 text-yellow-700"}`,children:G[t.product._id]==="updated"?"Updated":G[t.product._id]==="unchanged"?"Same Price":"Not in Last Order"})]})}),e.jsx("div",{className:"col-span-1",children:e.jsx("span",{className:"text-sm font-semibold text-gray-700 bg-gray-100 px-2 py-1 rounded border border-gray-200 block text-center h-8 flex items-center justify-center",children:((P=t.product.inventory)==null?void 0:P.currentStock)||0})}),e.jsx("div",{className:"col-span-1",children:e.jsx("input",{type:"number",value:t.quantity,onChange:h=>yt(t.product._id,parseInt(h.target.value)||1),className:"input text-center h-8",min:"1",max:((b=t.product.inventory)==null?void 0:b.currentStock)||999999,title:`Maximum available: ${((U=t.product.inventory)==null?void 0:U.currentStock)||0}`})}),de&&Re("view_cost_prices")&&e.jsx("div",{className:"col-span-1",children:e.jsx("span",{className:"text-sm font-semibold text-red-700 bg-red-50 px-2 py-1 rounded border border-red-200 block text-center h-8 flex items-center justify-center",title:"Last Purchase Price",children:K[t.product._id]!==void 0?`$${Math.round(K[t.product._id])}`:"N/A"})}),e.jsxs("div",{className:"col-span-1 relative",children:[e.jsx("input",{type:"number",step:"1",value:Math.round(t.unitPrice),onChange:h=>jt(t.product._id,parseInt(h.target.value)||0),className:`input text-center h-8 ${K[t.product._id]!==void 0&&t.unitPrice<K[t.product._id]?"bg-red-50 border-red-400 ring-2 ring-red-300":G[t.product._id]==="updated"?"bg-green-50 border-green-300 ring-1 ring-green-200":G[t.product._id]==="not-found"?"bg-yellow-50 border-yellow-300 ring-1 ring-yellow-200":G[t.product._id]==="unchanged"?"bg-blue-50 border-blue-300 ring-1 ring-blue-200":""}`,min:"0",title:K[t.product._id]!==void 0&&t.unitPrice<K[t.product._id]?`⚠️ WARNING: Sale price ($${Math.round(t.unitPrice)}) is below cost price ($${Math.round(K[t.product._id])})`:""}),F&&G[t.product._id]&&e.jsxs("div",{className:"absolute -right-7 top-1/2 transform -translate-y-1/2 flex items-center z-10",title:G[t.product._id]==="updated"?"Price updated from last order":G[t.product._id]==="unchanged"?"Price same as last order":"Product not found in previous order",children:[G[t.product._id]==="updated"&&e.jsx(nt,{className:"h-4 w-4 text-green-600 bg-white rounded-full"}),G[t.product._id]==="unchanged"&&e.jsx(ct,{className:"h-4 w-4 text-blue-600 bg-white rounded-full"}),G[t.product._id]==="not-found"&&e.jsx(ie,{className:"h-4 w-4 text-yellow-600 bg-white rounded-full"})]})]}),e.jsx("div",{className:"col-span-1",children:e.jsx("span",{className:"text-sm font-semibold text-gray-700 bg-gray-100 px-2 py-1 rounded border border-gray-200 block text-center h-8 flex items-center justify-center",children:Math.round(c)})}),e.jsx("div",{className:"col-span-1",children:e.jsx("button",{onClick:()=>et(t.product._id),className:"btn btn-danger btn-sm h-8 w-full",children:e.jsx(it,{className:"h-4 w-4"})})})]})},t.product._id)})]})]})]}),l.length>0&&e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg max-w-5xl ml-auto mt-4",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-blue-200",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 text-right mb-4",children:"Sales Details"}),e.jsxs("div",{className:"flex flex-nowrap gap-3 items-end justify-end",children:[e.jsxs("div",{className:"flex flex-col w-44",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Order Type"}),e.jsxs("select",{value:(s==null?void 0:s.businessType)||"wholesale",className:"input h-8 text-sm",disabled:!0,children:[e.jsx("option",{value:"retail",children:"Retail"}),e.jsx("option",{value:"wholesale",children:"Wholesale"}),e.jsx("option",{value:"return",children:"Return"}),e.jsx("option",{value:"exchange",children:"Exchange"})]})]}),e.jsxs("div",{className:"flex flex-col w-40",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Tax Status"}),e.jsxs("div",{className:"flex items-center space-x-1 px-2 py-1 border border-gray-200 rounded h-8",children:[e.jsx("input",{type:"checkbox",id:"taxExempt",checked:g,onChange:t=>_(t.target.checked),className:"h-3 w-3 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"}),e.jsx("div",{className:"flex-1",children:e.jsx("label",{htmlFor:"taxExempt",className:"text-xs font-medium text-gray-700 cursor-pointer",children:"Tax Exempt"})}),g&&e.jsx("div",{className:"text-green-600 text-xs font-medium",children:"✓"})]})]}),e.jsxs("div",{className:"flex flex-col w-72",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-1",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 m-0",children:"Invoice Number"}),e.jsxs("label",{htmlFor:"autoGenerateInvoice",className:"flex items-center space-x-1 text-[11px] text-gray-600 cursor-pointer select-none",children:[e.jsx("input",{type:"checkbox",id:"autoGenerateInvoice",checked:ae,onChange:t=>{xe(t.target.checked),t.target.checked&&s&&J(Be(s))},className:"h-3 w-3 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"}),e.jsx("span",{children:"Auto-generate"})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:re,onChange:t=>J(t.target.value),className:"w-full input pr-16 h-8 text-sm",placeholder:ae?"Auto-generated":"Enter invoice number",disabled:ae}),ae&&e.jsx("button",{type:"button",onClick:()=>{s&&J(Be(s))},className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-[11px] text-primary-600 hover:text-primary-800 font-medium",children:"Regenerate"})]})]}),e.jsxs("div",{className:"flex flex-col w-[28rem]",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("input",{type:"text",value:ne,onChange:t=>pe(t.target.value),className:"input h-8 text-sm",placeholder:"Additional notes..."})]})]})]}),e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4",children:e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Order Summary"})}),e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-800 font-semibold",children:"Subtotal:"}),e.jsx("span",{className:"text-xl font-bold text-gray-900",children:Math.round(ue)})]}),ye>0&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-800 font-semibold",children:"Discount:"}),e.jsxs("span",{className:"text-xl font-bold text-red-600",children:["-",Math.round(ye)]})]}),!g&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-800 font-semibold",children:"Tax (8%):"}),e.jsx("span",{className:"text-xl font-bold text-gray-900",children:Math.round(_e)})]}),s&&(()=>{const t=s.pendingBalance||0,r=s.advanceBalance||0,c=t-r;return t>0||r>0?e.jsxs("div",{className:"flex justify-between items-center mt-2",children:[e.jsx("span",{className:"text-gray-800 font-semibold",children:c<0?"Previous Advance:":"Previous Receivables:"}),e.jsxs("span",{className:`text-xl font-bold ${c<0?"text-red-600":"text-green-600"}`,children:[c<0?"-":"+",Math.abs(Math.round(c))]})]}):null})(),e.jsxs("div",{className:"flex justify-between items-center text-xl font-bold border-t-2 border-blue-400 pt-3 mt-2",children:[e.jsx("span",{className:"text-blue-900",children:"Total:"}),e.jsx("span",{className:"text-blue-900 text-3xl",children:Math.round(ee)})]}),s&&(()=>{const t=s.pendingBalance||0,r=s.advanceBalance||0,c=t-r;if(!(t>0||r>0))return null;const a=ee+c,p=a<0;return e.jsxs("div",{className:"flex justify-between items-center text-lg font-bold border-t-2 border-red-400 pt-3 mt-2",children:[e.jsx("span",{className:p?"text-red-700":"text-green-700",children:p?"Total Advance:":"Total Receivables:"}),e.jsx("span",{className:`text-2xl ${p?"text-red-700":"text-green-700"}`,children:Math.abs(Math.round(a))})]})})()]}),e.jsxs("div",{className:"mt-4 bg-white rounded-lg p-4 shadow-sm",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-[minmax(0,2fr)_minmax(0,1fr)_minmax(0,1fr)] gap-4 items-start",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-800 mb-2",children:"Apply Discount"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("select",{value:w.type,onChange:t=>M({...w,type:t.target.value}),className:"px-3 py-2 border-2 border-blue-200 rounded-md bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium h-[42px]",children:[e.jsx("option",{value:"amount",children:"Amount"}),e.jsx("option",{value:"percentage",children:"%"})]}),e.jsx("input",{type:"number",placeholder:w.type==="amount"?"Enter amount...":"Enter percentage...",value:w.value||"",onChange:t=>{const r=parseInt(t.target.value)||0;M({...w,value:r})},className:"flex-1 px-3 py-2 border-2 border-blue-200 rounded-md bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium text-gray-900 h-[42px]",min:"0",step:(w.type==="percentage","1")})]}),w.value>0&&e.jsx("div",{className:"text-sm text-green-700 font-semibold mt-2 bg-green-50 px-2 py-1 rounded",children:w.type==="percentage"?`${w.value}% = ${Math.round(Ce)} off`:`${Math.round(w.value)} off`})]}),e.jsxs("div",{className:"flex flex-col md:col-start-2 md:row-start-1 w-full",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-800 mb-2",children:"Payment Method"}),e.jsxs("select",{value:f,onChange:t=>{const r=t.target.value;$(r),r!=="bank"&&q("")},className:"w-full px-3 py-2 border-2 border-blue-200 rounded-md bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium text-gray-900 h-[42px]",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"bank",children:"Bank Transfer"}),e.jsx("option",{value:"credit_card",children:"Credit Card"}),e.jsx("option",{value:"debit_card",children:"Debit Card"}),e.jsx("option",{value:"check",children:"Check"}),e.jsx("option",{value:"account",children:"Account"}),e.jsx("option",{value:"split",children:"Split Payment"})]}),f==="bank"&&e.jsxs("div",{className:"mt-3",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Bank Account"}),e.jsxs("select",{value:k,onChange:t=>q(t.target.value),className:"w-full px-3 py-2 border-2 border-blue-200 rounded-md bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium text-gray-900 h-[42px]",children:[e.jsx("option",{value:"",children:"Select bank account..."}),be.map(t=>e.jsxs("option",{value:t._id,children:[t.bankName," - ",t.accountNumber,t.accountName?` (${t.accountName})`:""]},t._id))]}),banksLoading&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Loading bank accounts..."}),!banksLoading&&be.length===0&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"No bank accounts available. Add one in Banks."})]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-800 mb-2",children:"Amount Paid"}),e.jsx("input",{type:"number",step:"1",value:Math.round(x),onChange:t=>C(parseInt(t.target.value)||0),onFocus:t=>t.target.select(),className:"w-full px-3 py-2 border-2 border-blue-200 rounded-md bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium text-gray-900 text-lg h-[42px]",placeholder:"0"})]})]}),w.value>0&&e.jsx("div",{className:"mt-2",children:e.jsx("button",{onClick:()=>M({type:"amount",value:0}),className:"px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm",children:"Clear Discount"})})]}),e.jsxs("div",{className:"flex space-x-3 mt-6",children:[l.length>0&&e.jsxs("button",{onClick:_t,className:"btn btn-secondary flex-1",children:[e.jsx(it,{className:"h-4 w-4 mr-2"}),"Clear Cart"]}),l.length>0&&e.jsxs("button",{onClick:()=>{const t={orderNumber:`TEMP-${Date.now()}`,orderType:Fe(s==null?void 0:s.businessType),customer:s==null?void 0:s._id,customerInfo:s?{name:s.displayName,email:s.email,phone:s.phone,businessName:s.businessName}:null,items:l.map(r=>({product:{name:r.product.name},quantity:r.quantity,unitPrice:r.unitPrice})),pricing:{subtotal:ue,discountAmount:ye,taxAmount:_e,isTaxExempt:g,total:ee},payment:{method:f,bankAccount:f==="bank"?k:null,amountPaid:x,remainingBalance:ee-x,isPartialPayment:x<ee,isAdvancePayment:v,advanceAmount:v?x-ee:0},createdAt:new Date,createdBy:{name:"Current User"},invoiceNumber:re};H(t),N(!0)},className:"btn btn-secondary flex-1",children:[e.jsx(os,{className:"h-4 w-4 mr-2"}),"Print Preview"]}),e.jsxs(Ae,{onClick:Mt,isLoading:!1,className:"btn btn-primary btn-lg flex-2",children:[e.jsx(Vt,{className:"h-4 w-4 mr-2"}),u!=null&&u.isEditMode?x===0?"Update Invoice":"Update Sale":x===0?"Create Invoice":"Complete Sale"]})]})]})]}),l.length>0&&e.jsx("div",{className:"mt-4 max-w-5xl ml-auto",children:e.jsx(ps,{title:"Customers Also Bought",algorithm:"frequently_bought",context:{page:"sales",currentProducts:l.map(t=>t.product._id),customerTier:s==null?void 0:s.customerTier,businessType:s==null?void 0:s.businessType},limit:4,onAddToCart:Ze,onViewProduct:t=>{pt(t)}})})]}),e.jsx(Kt,{isOpen:Pt.isOpen,onClose:Ct,onConfirm:kt,itemCount:l.length,itemType:"items",isLoading:!1}),e.jsx(us,{isOpen:E,onClose:()=>{o(!1),H(null)},orderData:A,onPaymentSuccess:Et,onPaymentError:Lt}),e.jsx(Zt,{isOpen:j,onClose:()=>{N(!1),H(null)},orderData:A,documentTitle:"Sales Invoice",partyLabel:"Customer"}),xt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-lg w-full",children:[e.jsxs("div",{className:"flex justify-between items-center p-6 border-b border-gray-200",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Export Sales Report"}),e.jsx("button",{onClick:()=>{Ne(!1),Pe(ce.from),ke(ce.to)},className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(ls,{className:"h-6 w-6"})})]}),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Export Format"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("label",{className:"flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50",children:[e.jsx("input",{type:"radio",name:"format",value:"pdf",checked:Q==="pdf",onChange:t=>we(t.target.value),className:"mr-3"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"PDF"}),e.jsx("div",{className:"text-sm text-gray-500",children:"Print-ready format"})]})]}),e.jsxs("label",{className:"flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50",children:[e.jsx("input",{type:"radio",name:"format",value:"excel",checked:Q==="excel",onChange:t=>we(t.target.value),className:"mr-3"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"Excel"}),e.jsx("div",{className:"text-sm text-gray-500",children:"Spreadsheet format"})]})]}),e.jsxs("label",{className:"flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50",children:[e.jsx("input",{type:"radio",name:"format",value:"csv",checked:Q==="csv",onChange:t=>we(t.target.value),className:"mr-3"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"CSV"}),e.jsx("div",{className:"text-sm text-gray-500",children:"Comma-separated values"})]})]}),e.jsxs("label",{className:"flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50",children:[e.jsx("input",{type:"radio",name:"format",value:"json",checked:Q==="json",onChange:t=>we(t.target.value),className:"mr-3"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:"JSON"}),e.jsx("div",{className:"text-sm text-gray-500",children:"Data format"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Date Range (Optional)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"From Date"}),e.jsx("input",{type:"date",value:fe,onChange:t=>Pe(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"To Date"}),e.jsx("input",{type:"date",value:Se,onChange:t=>ke(t.target.value),min:fe,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"})]})]}),(fe||Se)&&e.jsx("button",{type:"button",onClick:()=>{Pe(ce.from),ke(ce.to)},className:"mt-2 text-sm text-primary-600 hover:text-primary-700",children:"Reset to default"})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4 border-t border-gray-200",children:[e.jsx("button",{type:"button",onClick:()=>{Ne(!1),Pe(ce.from),ke(ce.to)},className:"btn btn-secondary",disabled:Te,children:"Cancel"}),e.jsx("button",{type:"button",onClick:At,className:"btn btn-primary",disabled:Te,children:Te?e.jsxs(e.Fragment,{children:[e.jsx(Yt,{className:"h-4 w-4 mr-2"}),"Exporting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(at,{className:"h-4 w-4 mr-2"}),"Export"]})})]})]})})]})})]})};export{Ks as Sales};
